{# app/templates/cases/_case_property_tab.html #}

<style>
.property-section {
    background: var(--panel);
    border-radius: 10px;
    padding: 1.5rem;
    border: 1px solid #263043;
    margin-bottom: 1.5rem;
}

.property-section h3 {
    margin: 0 0 1rem 0;
    color: var(--text);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.property-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.property-field {
    display: flex;
    flex-direction: column;
}

.property-field label {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 0.25rem;
}

.property-field .value {
    color: var(--text);
    padding: 0.5rem;
    background: var(--bg);
    border-radius: 6px;
    border: 1px solid #263043;
}

.property-field input,
.property-field select {
    padding: 0.5rem;
    background: var(--bg);
    border: 1px solid #263043;
    border-radius: 6px;
    color: var(--text);
}

.edit-mode .property-field .value {
    display: none;
}

.edit-mode .property-field input,
.edit-mode .property-field select {
    display: block;
}

.property-field input,
.property-field select {
    display: none;
}

.flag-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--acc);
    color: white;
    border-radius: 4px;
    font-size: 0.85rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.flag-badge.false {
    background: #334155;
    color: var(--muted);
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.history-table th,
.history-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #263043;
}

.history-table th {
    background: #0f1629;
    color: var(--muted);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
}

.no-data {
    text-align: center;
    padding: 2rem;
    color: var(--muted);
}
</style>

{% if property_data %}

<!-- Owner Information -->
<div class="property-section">
    <h3>
        üë§ Owner Information
        <button type="button" class="btn" onclick="toggleEditMode('owner-section')">Edit</button>
    </h3>
    <form method="post" action="/cases/{{ case.id }}/property/update-owner" id="owner-section">
        
        {% if property_data.owners and property_data.owners|length > 0 %}
            
            {# List all owner names #}
            {% for owner in property_data.owners %}
            <div class="property-field" style="margin-bottom: 1rem;">
                <label>Owner {{ loop.index }}</label>
                <div class="value">{{ owner.fullName or 'N/A' }}</div>
                <input type="text" name="owner_name_{{ loop.index }}" value="{{ owner.fullName or '' }}">
            </div>
            {% endfor %}
            
            {# Single shared mailing address (use first owner's address) #}
            <h4 style="margin: 2rem 0 1rem 0; padding-top: 1.5rem; border-top: 1px solid #263043;">
                Mailing Address
            </h4>
            
            {% set shared_address = property_data.owners[0].mailingAddress %}
            
            <div class="property-grid">
                <div class="property-field">
                    <label>Street</label>
                    <div class="value">{{ shared_address.street or 'N/A' }}</div>
                    <input type="text" name="mailing_street" value="{{ shared_address.street or '' }}">
                </div>
                <div class="property-field">
                    <label>City</label>
                    <div class="value">{{ shared_address.city or 'N/A' }}</div>
                    <input type="text" name="mailing_city" value="{{ shared_address.city or '' }}">
                </div>
                <div class="property-field">
                    <label>State</label>
                    <div class="value">{{ shared_address.state or 'N/A' }}</div>
                    <input type="text" name="mailing_state" value="{{ shared_address.state or '' }}">
                </div>
                <div class="property-field">
                    <label>ZIP Code</label>
                    <div class="value">{{ shared_address.zipCode or 'N/A' }}</div>
                    <input type="text" name="mailing_zip" value="{{ shared_address.zipCode or '' }}">
                </div>
                <div class="property-field">
                    <label>County</label>
                    <div class="value">{{ shared_address.county or 'N/A' }}</div>
                    <input type="text" name="mailing_county" value="{{ shared_address.county or '' }}">
                </div>
            </div>
            
            <input type="hidden" name="owner_count" value="{{ property_data.owners|length }}">
            
        {% else %}
            {# Fallback for no owners data #}
            <div class="property-field">
                <label>Owner</label>
                <div class="value">N/A</div>
            </div>
        {% endif %}
        
        <button type="submit" class="btn" style="margin-top: 1rem; display: none;">Save Changes</button>
    </form>
</div>

<!-- QuickList Flags -->
{% if property_data.quickList %}
<div class="property-section">
    <h3>üè∑Ô∏è Property Flags</h3>
    <div>
        {% for key, value in property_data.quickList.items() %}
            <span class="flag-badge {% if not value %}false{% endif %}">
                {{ key | replace('_', ' ') | title }}: {{ '‚úì' if value else '‚úó' }}
            </span>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Valuation -->
{% if property_data.valuation %}
<div class="property-section">
    <h3>
        üí∞ Valuation
        <button type="button" class="btn" onclick="toggleEditMode('valuation-section')">Edit</button>
    </h3>
    <form method="post" action="/cases/{{ case.id }}/property/update-valuation" id="valuation-section">
        <div class="property-grid">
            <div class="property-field">
                <label>Estimated Value</label>
                <div class="value">${{ "{:,.0f}".format(property_data.valuation.estimatedValue) if property_data.valuation.estimatedValue else 'N/A' }}</div>
                <input type="number" name="estimated_value" step="0.01" value="{{ property_data.valuation.estimatedValue or '' }}">
            </div>
            <div class="property-field">
    <label>As of Date</label>
    <div class="value">{{ property_data.valuation.asOfDate | format_date }}</div>
    <input type="date" name="as_of_date" value="{{ property_data.valuation.asOfDate or '' }}">
</div>
            <div class="property-field">
                <label>Confidence Score</label>
                <div class="value">{{ property_data.valuation.confidenceScore or 'N/A' }}</div>
                <input type="number" name="confidence_score" step="0.01" value="{{ property_data.valuation.confidenceScore or '' }}">
            </div>
            <div class="property-field">
                <label>Equity Percent</label>
                <div class="value">{{ "{:.1f}%".format(property_data.valuation.equityPercent) if property_data.valuation.equityPercent else 'N/A' }}</div>
                <input type="number" name="equity_percent" step="0.01" value="{{ property_data.valuation.equityPercent or '' }}">
            </div>
            <div class="property-field">
                <label>LTV (Loan to Value)</label>
                <div class="value">{{ "{:.1f}%".format(property_data.valuation.ltv) if property_data.valuation.ltv else 'N/A' }}</div>
                <input type="number" name="ltv" step="0.01" value="{{ property_data.valuation.ltv or '' }}">
            </div>
        </div>
        <button type="submit" class="btn" style="margin-top: 1rem; display: none;">Save Changes</button>
    </form>
</div>
{% endif %}

<!-- Intel -->
{% if property_data.intel %}
<div class="property-section">
    <h3>üìä Intelligence Data</h3>
    <div class="property-grid">
        <div class="property-field">
            <label>Sale Propensity</label>
            <div class="value">{{ property_data.intel.salePropensity or 'N/A' }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Demographics -->
{% if property_data.demographics %}
<div class="property-section">
    <h3>
        üë• Demographics
        <button type="button" class="btn" onclick="toggleEditMode('demographics-section')">Edit</button>
    </h3>
    <form method="post" action="/cases/{{ case.id }}/property/update-demographics" id="demographics-section">
        <div class="property-grid">
            <div class="property-field">
                <label>Age</label>
                <div class="value">{{ property_data.demographics.age or 'N/A' }}</div>
                <input type="number" name="age" value="{{ property_data.demographics.age or '' }}">
            </div>
            <div class="property-field">
                <label>Gender</label>
                <div class="value">{{ property_data.demographics.gender or 'N/A' }}</div>
                <select name="gender">
                    <option value="">Unknown</option>
                    <option value="Male" {% if property_data.demographics.gender == 'Male' %}selected{% endif %}>Male</option>
                    <option value="Female" {% if property_data.demographics.gender == 'Female' %}selected{% endif %}>Female</option>
                </select>
            </div>
            <div class="property-field">
                <label>Marital Status</label>
                <div class="value">{{ property_data.demographics.maritalStatus or 'N/A' }}</div>
                <input type="text" name="marital_status" value="{{ property_data.demographics.maritalStatus or '' }}">
            </div>
            <div class="property-field">
                <label>Children Count</label>
                <div class="value">{{ property_data.demographics.childCount or 'N/A' }}</div>
                <input type="number" name="child_count" value="{{ property_data.demographics.childCount or '' }}">
            </div>
            <div class="property-field">
                <label>Income</label>
                <div class="value">${{ "{:,.0f}".format(property_data.demographics.income) if property_data.demographics.income else 'N/A' }}</div>
                <input type="number" name="income" step="1000" value="{{ property_data.demographics.income or '' }}">
            </div>
            <div class="property-field">
                <label>Net Worth</label>
                <div class="value">${{ "{:,.0f}".format(property_data.demographics.netWorth) if property_data.demographics.netWorth else 'N/A' }}</div>
                <input type="number" name="net_worth" step="1000" value="{{ property_data.demographics.netWorth or '' }}">
            </div>
            <div class="property-field">
                <label>Occupation</label>
                <div class="value">{{ property_data.demographics.individualOccupation or 'N/A' }}</div>
                <input type="text" name="occupation" value="{{ property_data.demographics.individualOccupation or '' }}">
            </div>
        </div>
        <button type="submit" class="btn" style="margin-top: 1rem; display: none;">Save Changes</button>
    </form>
</div>
{% endif %}

<!-- Property Details -->
{% if property_data.properties %}
<div class="property-section">
    <h3>üè† Property Details</h3>
    <div class="property-grid">
        <div class="property-field">
            <label>Street Address</label>
            <div class="value">{{ property_data.properties.street or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>City</label>
            <div class="value">{{ property_data.properties.city or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>State</label>
            <div class="value">{{ property_data.properties.state or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>ZIP Code</label>
            <div class="value">{{ property_data.properties.zipCode or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>County</label>
            <div class="value">{{ property_data.properties.county or 'N/A' }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- IDs -->
{% if property_data.ids %}
<div class="property-section">
    <h3>üî¢ Property IDs</h3>
    <div class="property-grid">
        <div class="property-field">
            <label>APN (Assessor's Parcel Number)</label>
            <div class="value">{{ property_data.ids.apn or 'N/A' }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Mortgage History -->
{% if property_data.mortgageHistory and property_data.mortgageHistory | length > 0 %}
<div class="property-section">
    <h3>üè¶ Mortgage History</h3>
    <div style="overflow-x: auto;">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Document Date</th>
                    <th>Lender</th>
                    <th>Loan Amount</th>
                    <th>Interest Rate</th>
                    <th>Loan Type</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody>
                {% for mortgage in property_data.mortgageHistory %}
                <tr>
    <td>{{ mortgage.documentDate | format_date }}</td>
    <td>{{ mortgage.lenderName or 'N/A' }}</td>
    <td>${{ "{:,.0f}".format(mortgage.loanAmount) if mortgage.loanAmount else 'N/A' }}</td>
    <td>{{ "{:.2f}%".format(mortgage.interestRate) if mortgage.interestRate else 'N/A' }}</td>
    <td>{{ mortgage.loanType or 'N/A' }}</td>
    <td>{{ mortgage.dueDate | format_date }}</td>
</tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Deed History -->
{% if property_data.deedHistory and property_data.deedHistory | length > 0 %}
<div class="property-section">
    <h3>üìú Deed History</h3>
    <div style="overflow-x: auto;">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Document Date</th>
                    <th>Document Type</th>
                    <th>Sale Price</th>
                    <th>Buyers</th>
                </tr>
            </thead>
            <tbody>
                {% for deed in property_data.deedHistory %}
                <tr>
    <td>{{ deed.documentDate | format_date }}</td>
    <td>{{ deed.documentType or 'N/A' }}</td>
    <td>${{ "{:,.0f}".format(deed.salePrice) if deed.salePrice else 'N/A' }}</td>
    <td>{{ deed.buyers or 'N/A' }}</td>
</tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Foreclosure Info -->
{% if property_data.foreclosure %}
<div class="property-section">
    <h3>‚öñÔ∏è Foreclosure Information</h3>
    <div class="property-grid">
        <div class="property-field">
            <label>Case Number</label>
            <div class="value">{{ property_data.foreclosure.caseNumber or 'N/A' }}</div>
        </div>
        <div class="property-field">
    <label>Filing Date</label>
    <div class="value">{{ property_data.foreclosure.filingDate | format_date }}</div>
</div>
        <div class="property-field">
            <label>Current Lender</label>
            <div class="value">{{ property_data.foreclosure.currentLenderName or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>Document Type</label>
            <div class="value">{{ property_data.foreclosure.documentType or 'N/A' }}</div>
        </div>
    </div>
</div>
{% endif %}

<details style="margin-top: 2rem;">
    <summary style="cursor: pointer; color: var(--muted); font-size: 0.9rem;">
        üîç View Raw JSON Data
    </summary>
    <pre style="background: #0f1629; padding: 1rem; border-radius: 8px; overflow-x: auto; margin-top: 1rem; font-size: 0.85rem;">{{ property_payload | tojson(indent=2) if property_payload else 'No data' }}</pre>
</details>

<script>
function toggleEditMode(sectionId) {
    const section = document.getElementById(sectionId);
    const isEditing = section.classList.contains('edit-mode');
    
    if (isEditing) {
        section.classList.remove('edit-mode');
        section.querySelector('button[type="submit"]').style.display = 'none';
    } else {
        section.classList.add('edit-mode');
        section.querySelector('button[type="submit"]').style.display = 'block';
    }
}
</script>

{% else %}

<div class="no-data">
    <h3 style="margin: 0 0 1rem 0;">üì≠ No Property Data Available</h3>
    <p style="color: var(--muted); margin-bottom: 1.5rem;">
        Property data has not been fetched yet.
    </p>
    <a href="/cases/{{ case.id }}/property-lookup" class="btn">
        üîç Fetch Property Data ($0.10-0.25)
    </a>
</div>

{% endif %}
