{% extends "base.html" %}
{% block title %}Cases - JSN Holdings{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
        <h1 class="page-title">Cases</h1>
        <p class="page-subtitle">Manage your foreclosure cases and track progress.</p>
    </div>
    <div style="display: flex; gap: var(--space-sm); align-items: center;">
        <!-- V3: My Claims Counter -->
        <div id="claims-counter" class="claims-counter" style="display: none;">
            <span class="claims-count">0</span>
            <span class="claims-label">/ 50 claimed</span>
        </div>
        <a href="/cases/new" class="btn btn-primary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="16"/>
                <line x1="8" y1="12" x2="16" y2="12"/>
            </svg>
            Add Case
        </a>
    </div>
</div>

<!-- Filters & Actions Bar -->
<div class="card" style="margin-bottom: var(--space-lg);">
    <div class="card-body" style="padding: var(--space-md) var(--space-lg);">
        <form id="bulk-actions" method="post">
            <div style="display: flex; gap: var(--space-md); align-items: center; flex-wrap: wrap;">
                <!-- Search -->
                <div style="position: relative; flex: 1; min-width: 200px; max-width: 300px;">
                    <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: var(--text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="search" name="case" value="{{ search_query or '' }}" placeholder="Search address..." 
                           style="padding-left: 40px;">
                </div>
                <button type="submit" formaction="/cases" formmethod="get" class="btn btn-secondary">Search</button>
                
                <!-- Tag Filter -->
                <select name="tag" onchange="this.form.action='/cases'; this.form.method='get'; this.form.submit();" style="min-width: 120px;">
                    <option value="">All Tags</option>
                    {% for t in tag_options %}
                        <option value="{{ t }}" {% if tag_filter == t %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                </select>
                
                <!-- V3: Claim Filter -->
                <select name="claim_filter" onchange="this.form.action='/cases'; this.form.method='get'; this.form.submit();" style="min-width: 130px;">
                    <option value="">All Cases</option>
                    <option value="mine" {% if claim_filter == 'mine' %}selected{% endif %}>My Claims</option>
                    <option value="available" {% if claim_filter == 'available' %}selected{% endif %}>Available</option>
                    <option value="claimed" {% if claim_filter == 'claimed' %}selected{% endif %}>All Claimed</option>
                </select>
                
                <!-- Page Size -->
                <select name="page_size" onchange="this.form.action='/cases'; this.form.method='get'; this.form.submit();" style="width: 80px;">
                    {% for n in [10, 25, 50, 100] %}
                        <option value="{{ n }}" {% if page_size == n %}selected{% endif %}>{{ n }}</option>
                    {% endfor %}
                </select>
                
                <!-- Show New Toggle (no address) -->
                <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer; font-size: 14px; color: var(--text-secondary);">
                    <input type="checkbox" id="show-new-toggle" {% if show_new %}checked{% endif %}
                           onclick="window.location.href='?page=1&show_new='+(this.checked?1:0)+'&show_archived=0&page_size={{ page_size }}&sort_by={{ sort_by or 'case_number' }}&sort_order={{ sort_order or 'desc' }}'{% if tag_filter %}+'&tag={{ tag_filter }}'{% endif %}"
                           style="width: 18px; height: 18px;">
                    Show new
                </label>
                
                <!-- Show Archived Toggle -->
                <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer; font-size: 14px; color: var(--text-secondary);">
                    <input type="checkbox" id="show-archived-toggle" {% if show_archived %}checked{% endif %}
                           onclick="window.location.href='?page={{ pagination.page }}&show_archived='+(this.checked?1:0)+'&page_size={{ page_size }}&sort_by={{ sort_by or 'case_number' }}&sort_order={{ sort_order or 'desc' }}'{% if search_query %}+'&case={{ search_query }}'{% endif %}{% if tag_filter %}+'&tag={{ tag_filter }}'{% endif %}"
                           style="width: 18px; height: 18px;">
                    Show archived
                </label>
                
                <div style="border-left: 1px solid var(--border); height: 32px; margin: 0 var(--space-sm);"></div>
                
                <!-- V3: Bulk Claim/Release Buttons -->
                <button type="button" id="btn-claim" class="btn btn-primary btn-sm" style="display: none;">
                    ðŸ”’ Claim Selected
                </button>
                <button type="button" id="btn-release" class="btn btn-secondary btn-sm" style="display: none;">
                    ðŸ”“ Release Selected
                </button>
                
                <div style="border-left: 1px solid var(--border); height: 32px; margin: 0 var(--space-sm);"></div>
                
                <!-- Existing Bulk Actions -->
                <button type="submit" id="btn-archive" formaction="/cases/archive" formmethod="post" class="btn btn-secondary btn-sm">Archive</button>
                <button type="submit" id="btn-unarchive" formaction="/cases/unarchive" formmethod="post" class="btn btn-secondary btn-sm">Unarchive</button>
                <button type="submit" id="btn-export" formaction="/cases/export" formmethod="post" class="btn btn-secondary btn-sm">Export CSV</button>
                <button type="submit" id="btn-export-crm" formaction="/cases/export_crm" formmethod="post" class="btn btn-secondary btn-sm">Export CRM</button>
                <button type="submit" id="btn-deal-calcs" formaction="/cases/reports/download" formmethod="post" class="btn btn-secondary btn-sm">Deal Calcs</button>
                
                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-muted);">
                    <input type="checkbox" name="include_attachments" value="1" checked style="width: 14px; height: 14px;">
                    Include docs
                </label>
                
                <input type="hidden" name="show_archived" value="{{ 1 if show_archived else 0 }}">
                <input type="hidden" name="page" value="{{ pagination.page }}">
            </div>
        </form>
    </div>
</div>

{% if cases %}
<!-- Toast notification -->
<div id="toast" style="display:none; position:fixed; right:20px; bottom:20px; background:var(--surface); color:var(--text); padding:12px 20px; border-radius:var(--radius-md); box-shadow:var(--shadow-lg); border:1px solid var(--border); z-index:9999;">Done.</div>

<!-- Cases Table -->
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="check-all" style="width: 18px; height: 18px;">
                </th>
                <th>
                    <a href="?page=1&page_size={{ page_size }}&show_archived={{ 1 if show_archived else 0 }}&sort_by=case_number&sort_order={% if sort_by == 'case_number' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&case={{ search_query }}{% endif %}{% if tag_filter %}&tag={{ tag_filter }}{% endif %}" 
                       style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                        Case #
                        {% if sort_by == 'case_number' %}
                            <span style="font-size: 12px;">{% if sort_order == 'asc' %}â†‘{% else %}â†“{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="?page=1&page_size={{ page_size }}&show_archived={{ 1 if show_archived else 0 }}&sort_by=filing_datetime&sort_order={% if sort_by == 'filing_datetime' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&case={{ search_query }}{% endif %}{% if tag_filter %}&tag={{ tag_filter }}{% endif %}" 
                       style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                        Filed
                        {% if sort_by == 'filing_datetime' %}
                            <span style="font-size: 12px;">{% if sort_order == 'asc' %}â†‘{% else %}â†“{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="?page=1&page_size={{ page_size }}&show_archived={{ 1 if show_archived else 0 }}&sort_by=style&sort_order={% if sort_by == 'style' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&case={{ search_query }}{% endif %}{% if tag_filter %}&tag={{ tag_filter }}{% endif %}" 
                       style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                        Style
                        {% if sort_by == 'style' %}
                            <span style="font-size: 12px;">{% if sort_order == 'asc' %}â†‘{% else %}â†“{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="?page=1&page_size={{ page_size }}&show_archived={{ 1 if show_archived else 0 }}&sort_by=address&sort_order={% if sort_by == 'address' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&case={{ search_query }}{% endif %}{% if tag_filter %}&tag={{ tag_filter }}{% endif %}" 
                       style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                        Address
                        {% if sort_by == 'address' %}
                            <span style="font-size: 12px;">{% if sort_order == 'asc' %}â†‘{% else %}â†“{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th style="width: 100px;">Status</th>
                <th style="width: 70px;">Score</th>
            </tr>
        </thead>
        <tbody id="case-tbody">
            {% for c in cases %}
            {% set has_tags = c.archived or short_sale.get(c.id) or quick_flags.get(c.id, []) %}
            {% set is_mine = c.assigned_to == current_user.id if current_user else False %}
            {% set is_claimed = c.assigned_to is not none %}
            <tr data-href="/cases/{{ c.id }}" data-id="{{ c.id }}" data-archived="{{ 1 if c.archived else 0 }}" 
                data-claimed="{{ 1 if is_claimed else 0 }}" data-mine="{{ 1 if is_mine else 0 }}"
                tabindex="0" role="link" aria-label="Open case {{ c.case_number }}"
                style="cursor: pointer; {% if c.archived %}opacity: 0.5;{% endif %}{% if has_tags %}border-bottom: none;{% endif %}">
                <td onclick="event.stopPropagation()"{% if has_tags %} rowspan="2" style="vertical-align: middle;"{% endif %}>
                    <input type="checkbox" name="ids" value="{{ c.id }}" onclick="event.stopPropagation(); updateClaimButtons();" style="width: 18px; height: 18px;">
                </td>
                <td><strong style="color: var(--primary);">{{ c.case_number }}</strong></td>
                <td style="color: var(--text-secondary);">{{ c.filing_datetime }}</td>
                <td class="truncate" style="max-width: 200px;">{{ c.style }}</td>
                <td>
                    {% set addr = (c.address_override or c.address or '').strip() %}
                    {% if addr %}{{ addr }}{% else %}<span style="color: var(--text-muted);">â€”</span>{% endif %}
                </td>
                <!-- V3: Claim Status Column -->
                <td onclick="event.stopPropagation()">
                    {% if is_mine %}
                        <span class="badge badge-success" title="You own this case">
                            ðŸ”’ Mine
                        </span>
                    {% elif is_claimed %}
                        <span class="badge badge-warning" title="Claimed by another user">
                            ðŸ”’ Claimed
                        </span>
                    {% else %}
                        <button class="btn btn-primary btn-sm claim-btn" 
                                data-case-id="{{ c.id }}"
                                onclick="event.stopPropagation(); claimCase({{ c.id }});"
                                style="padding: 4px 8px; font-size: 12px;">
                            Claim
                        </button>
                    {% endif %}
                </td>
                <td class="deal-score-cell" data-case-id="{{ c.id }}">
                    <span style="color: var(--text-muted);">â€”</span>
                </td>
            </tr>
            {% if has_tags %}
            <tr data-href="/cases/{{ c.id }}" data-id="{{ c.id }}-tags" 
                style="cursor: pointer; {% if c.archived %}opacity: 0.5;{% endif %}">
                <td colspan="6" style="padding-top: 0; padding-bottom: 12px; border-top: none;">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        {% if c.archived %}<span class="badge badge-neutral">Archived</span>{% endif %}
                        {% if short_sale.get(c.id) %}<span class="badge badge-warning">Short Sale</span>{% endif %}
                        {% for tag in quick_flags.get(c.id, []) %}
                            <span class="badge badge-success">{{ tag }}</span>
                        {% endfor %}
                    </div>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
</form>

<!-- Pagination -->
<nav class="pagination" aria-label="Pagination" style="justify-content: center; margin-top: var(--space-xl);">
    {% if pagination.page > 1 %}
        <a href="?page=1&page_size={{ page_size }}&show_archived={{ 1 if show_archived else 0 }}&sort_by={{ sort_by or 'case_number' }}&sort_order={{ sort_order or 'desc' }}{% if search_query %}&case={{ search_query }}{% endif %}{% if tag_filter %}&tag={{ tag_filter }}{% endif %}">Â« First</a>
        <a href="?page={{ pagination.page - 1 }}&page_size={{ page_size }}&show_archived={{ 1 if show_archived else 0 }}&sort_by={{ sort_by or 'case_number' }}&sort_order={{ sort_order or 'desc' }}{% if search_query %}&case={{ search_query }}{% endif %}{% if tag_filter %}&tag={{ tag_filter }}{% endif %}">â€¹ Prev</a>
    {% else %}
        <span class="disabled">Â« First</span>
        <span class="disabled">â€¹ Prev</span>
    {% endif %}
    
    <span class="active">Page {{ pagination.page }} of {{ pagination.pages }}</span>
    
    {% if pagination.page < pagination.pages %}
        <a href="?page={{ pagination.page + 1 }}&page_size={{ page_size }}&show_archived={{ 1 if show_archived else 0 }}&sort_by={{ sort_by or 'case_number' }}&sort_order={{ sort_order or 'desc' }}{% if search_query %}&case={{ search_query }}{% endif %}{% if tag_filter %}&tag={{ tag_filter }}{% endif %}">Next â€º</a>
        <a href="?page={{ pagination.pages }}&page_size={{ page_size }}&show_archived={{ 1 if show_archived else 0 }}&sort_by={{ sort_by or 'case_number' }}&sort_order={{ sort_order or 'desc' }}{% if search_query %}&case={{ search_query }}{% endif %}{% if tag_filter %}&tag={{ tag_filter }}{% endif %}">Last Â»</a>
    {% else %}
        <span class="disabled">Next â€º</span>
        <span class="disabled">Last Â»</span>
    {% endif %}
</nav>

{% else %}
<div class="card">
    <div class="card-body" style="text-align: center; padding: var(--space-2xl);">
        <div style="font-size: 48px; margin-bottom: var(--space-md);">ðŸ“‚</div>
        <h3 style="margin-bottom: var(--space-sm);">No cases yet</h3>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
            Get started by importing cases or adding one manually.
        </p>
        <div style="display: flex; gap: var(--space-md); justify-content: center;">
            <a href="/import" class="btn btn-primary">Update Case List</a>
            <a href="/cases/new" class="btn btn-secondary">Add Case Manually</a>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<style>
/* V3: Claims Counter Styles */
.claims-counter {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    background: var(--bg-alt);
    border-radius: var(--radius-full);
    font-size: 13px;
}

.claims-count {
    font-weight: 700;
    color: var(--primary);
}

.claims-label {
    color: var(--text-muted);
}

/* V3: Claim button in table */
.claim-btn {
    transition: all 0.2s ease;
}

.claim-btn:hover {
    transform: scale(1.05);
}

.claim-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* V3: Status badges */
.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 500;
}

.badge-success {
    background: var(--success-light);
    color: var(--success);
}

.badge-warning {
    background: var(--warning-light);
    color: #b45309;
}

.badge-neutral {
    background: var(--bg-alt);
    color: var(--text-muted);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
(function(){
    function qs(sel, root){ return (root||document).querySelector(sel); }
    function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
    const tbody = qs('#case-tbody');
    const checkAll = qs('#check-all');
    const toast = qs('#toast');
    
    function showToast(msg, type){
        toast.textContent = msg || 'Done.';
        toast.style.background = type === 'error' ? 'var(--danger-light)' : 'var(--surface)';
        toast.style.color = type === 'error' ? 'var(--danger)' : 'var(--text)';
        toast.style.display = 'block';
        setTimeout(()=> toast.style.display='none', 3000);
    }
    
    // Row navigation
    if (tbody){
        tbody.addEventListener('click', function(e){
            const tr = e.target.closest('tr[data-href]');
            if (tr && !(e.target.tagName === 'A' || e.target.closest('a') || e.target.type === 'checkbox' || e.target.closest('button'))) {
                window.location.href = tr.getAttribute('data-href');
            }
        });
        tbody.addEventListener('keydown', function(e){
            const tr = e.target.closest('tr[data-href]');
            if (tr && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                window.location.href = tr.getAttribute('data-href');
            }
        });
    }
    
    // Select all
    if (checkAll){
        checkAll.addEventListener('change', function(){
            qsa('input[name="ids"]').forEach(cb => cb.checked = checkAll.checked);
            updateClaimButtons();
        });
    }

    function selectedIds(){
        return qsa('input[name="ids"]:checked').map(cb => parseInt(cb.value, 10)).filter(Boolean);
    }
    
    function hideTr(id){
        const tr = qs('tr[data-id="'+id+'"]');
        if (tr) tr.remove();
    }
    
    function markArchived(id, archived){
        const tr = qs('tr[data-id="'+id+'"]');
        if (!tr) return;
        tr.dataset.archived = archived ? '1' : '0';
        tr.style.opacity = archived ? '0.5' : '1';
    }

    async function postJSON(url, payload){
        const res = await fetch(url, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok){ 
            const err = await res.json().catch(() => ({ detail: 'Request failed' }));
            throw new Error(err.detail || 'Request failed');
        }
        return res.json();
    }

    async function postForm(url, payload){
        const form = new FormData();
        if (payload && payload.ids){
            payload.ids.forEach(id => form.append('ids', id));
        }
        const res = await fetch(url, { method: 'POST', body: form });
        if (!res.ok){ throw new Error('Request failed: ' + res.status); }
        const ctype = res.headers.get('content-type') || '';
        if (ctype.includes('application/json')) return res.json();
        return {};
    }

    async function postExport(url, payload){
        const form = new FormData();
        if (payload && payload.ids){
            payload.ids.forEach(id => form.append('ids', id));
        }
        const showArchived = {{ 1 if show_archived else 0 }};
        const search = {{ search_query|tojson|safe }};
        form.append('show_archived', showArchived);
        form.append('case', search || '');

        const res = await fetch(url, { method: 'POST', body: form });
        if (!res.ok){ throw new Error('Export failed: ' + res.status); }
        const blob = await res.blob();
        const dispo = res.headers.get('Content-Disposition') || 'attachment; filename="cases_export.csv"';
        const match = dispo.match(/filename="?([^"]+)"?/i);
        const filename = match ? match[1] : 'cases_export.csv';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{
            URL.revokeObjectURL(a.href);
            a.remove();
        }, 0);
    }

    // ============================================================
    // V3: CLAIM FUNCTIONALITY
    // ============================================================
    
    const btnClaim = qs('#btn-claim');
    const btnRelease = qs('#btn-release');
    
    // Update claim/release button visibility based on selection
    window.updateClaimButtons = function() {
        const ids = selectedIds();
        const selectedRows = ids.map(id => qs(`tr[data-id="${id}"]`)).filter(Boolean);
        
        // Check what's selected
        const hasUnclaimed = selectedRows.some(tr => tr.dataset.claimed === '0');
        const hasMine = selectedRows.some(tr => tr.dataset.mine === '1');
        
        // Show/hide buttons based on selection
        if (btnClaim) {
            btnClaim.style.display = hasUnclaimed && ids.length > 0 ? 'inline-flex' : 'none';
            btnClaim.textContent = `ðŸ”’ Claim (${selectedRows.filter(tr => tr.dataset.claimed === '0').length})`;
        }
        if (btnRelease) {
            btnRelease.style.display = hasMine && ids.length > 0 ? 'inline-flex' : 'none';
            btnRelease.textContent = `ðŸ”“ Release (${selectedRows.filter(tr => tr.dataset.mine === '1').length})`;
        }
    };
    
    // Single case claim
    window.claimCase = async function(caseId) {
        const btn = qs(`.claim-btn[data-case-id="${caseId}"]`);
        if (btn) {
            btn.disabled = true;
            btn.textContent = '...';
        }
        
        try {
            const result = await postJSON('/api/v3/cases/claim', { case_ids: [caseId] });
            showToast(`Case claimed! Score: ${result.score}, ${result.price_display}/day`);
            
            // Update the row
            const tr = qs(`tr[data-id="${caseId}"]`);
            if (tr) {
                tr.dataset.claimed = '1';
                tr.dataset.mine = '1';
                
                // Replace button with badge
                const statusCell = btn.closest('td');
                statusCell.innerHTML = '<span class="badge badge-success">ðŸ”’ Mine</span>';
            }
            
            // Update claims counter
            loadClaimsCount();
            
        } catch (err) {
            showToast(err.message, 'error');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Claim';
            }
        }
    };
    
    // Bulk claim
    if (btnClaim) {
        btnClaim.addEventListener('click', async function() {
            const ids = selectedIds();
            const unclaimedIds = ids.filter(id => {
                const tr = qs(`tr[data-id="${id}"]`);
                return tr && tr.dataset.claimed === '0';
            });
            
            if (unclaimedIds.length === 0) {
                showToast('No unclaimed cases selected', 'error');
                return;
            }
            
            btnClaim.disabled = true;
            btnClaim.textContent = 'Claiming...';
            
            try {
                const result = await postJSON('/api/v3/cases/claim', { case_ids: unclaimedIds });
                showToast(result.message);
                
                // Reload page to show updated status
                setTimeout(() => window.location.reload(), 500);
                
            } catch (err) {
                showToast(err.message, 'error');
                btnClaim.disabled = false;
                updateClaimButtons();
            }
        });
    }
    
    // Bulk release
    if (btnRelease) {
        btnRelease.addEventListener('click', async function() {
            const ids = selectedIds();
            const mineIds = ids.filter(id => {
                const tr = qs(`tr[data-id="${id}"]`);
                return tr && tr.dataset.mine === '1';
            });
            
            if (mineIds.length === 0) {
                showToast('No owned cases selected', 'error');
                return;
            }
            
            if (!confirm(`Release ${mineIds.length} case(s)? You will lose exclusive access.`)) {
                return;
            }
            
            btnRelease.disabled = true;
            btnRelease.textContent = 'Releasing...';
            
            try {
                const result = await postJSON('/api/v3/cases/release', { case_ids: mineIds });
                showToast(result.message);
                
                // Reload page to show updated status
                setTimeout(() => window.location.reload(), 500);
                
            } catch (err) {
                showToast(err.message, 'error');
                btnRelease.disabled = false;
                updateClaimButtons();
            }
        });
    }
    
    // Load claims count
    async function loadClaimsCount() {
        try {
            const res = await fetch('/api/v3/claims/count');
            if (res.ok) {
                const data = await res.json();
                const counter = qs('#claims-counter');
                if (counter) {
                    counter.style.display = 'flex';
                    counter.querySelector('.claims-count').textContent = data.active_claims;
                    counter.querySelector('.claims-label').textContent = `/ ${data.max_claims} claimed`;
                }
            }
        } catch (e) {
            console.log('Could not load claims count');
        }
    }

    // ============================================================
    // EXISTING FUNCTIONALITY
    // ============================================================
    
    const btnArchive = qs('#btn-archive');
    const btnUnarchive = qs('#btn-unarchive');
    const btnExport = qs('#btn-export');

    if (btnArchive){
        btnArchive.addEventListener('click', async function(e){
            if (!e.shiftKey){ e.preventDefault(); }
            const ids = selectedIds();
            if (ids.length === 0) return;
            try{
                await postForm('/cases/archive_async', { ids });
                const showArchived = {{ 1 if show_archived else 0 }};
                ids.forEach(id => showArchived ? markArchived(id, true) : hideTr(id));
                showToast('Archived ' + ids.length + ' case(s).');
            } catch(err){ alert(err.message); }
        });
    }

    if (btnUnarchive){
        btnUnarchive.addEventListener('click', async function(e){
            if (!e.shiftKey){ e.preventDefault(); }
            const ids = selectedIds();
            if (ids.length === 0) return;
            try{
                await postForm('/cases/unarchive_async', { ids });
                const showArchived = {{ 1 if show_archived else 0 }};
                ids.forEach(id => markArchived(id, false));
                showToast('Unarchived ' + ids.length + ' case(s).');
            } catch(err){ alert(err.message); }
        });
    }

    if (btnExport){
        btnExport.addEventListener('click', async function(e){
            if (!e.shiftKey){ e.preventDefault(); }
            const ids = selectedIds();
            try{
                await postExport('/cases/export', { ids });
                showToast('Export startedâ€¦');
            } catch(err){ alert(err.message); }
        });
    }
    
    // Initialize
    loadClaimsCount();
})();

// Load Deal Scores
(function() {
    async function loadDealScores() {
        const cells = document.querySelectorAll('.deal-score-cell');
        if (cells.length === 0) return;
        
        const caseIds = Array.from(cells).map(c => c.dataset.caseId);
        
        for (let i = 0; i < Math.min(caseIds.length, 20); i++) {
            const caseId = caseIds[i];
            const cell = document.querySelector(`.deal-score-cell[data-case-id="${caseId}"]`);
            if (!cell) continue;
            
            try {
                const response = await fetch(`/api/v2/cases/${caseId}/analyze`, { method: 'POST' });
                if (response.ok) {
                    const analysis = await response.json();
                    if (analysis.score !== undefined) {
                        const scoreClass = DealAnalysis.getScoreClass(analysis.score);
                        cell.innerHTML = `<span class="deal-score-badge ${scoreClass}">${analysis.score}</span>`;
                    }
                }
            } catch (e) {}
        }
    }
    
    setTimeout(loadDealScores, 500);
})();
</script>
{% endblock %}
