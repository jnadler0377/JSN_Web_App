{% extends "base.html" %}
{% block title %}Admin Panel - JSN Holdings{% endblock %}

{% block content %}
<style>
.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
}

.admin-tabs {
    display: flex;
    gap: 4px;
    background: var(--bg-alt);
    padding: 4px;
    border-radius: var(--radius-md);
    margin-bottom: 24px;
}

.admin-tab {
    padding: 10px 20px;
    border: none;
    background: transparent;
    border-radius: var(--radius-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-secondary);
}

.admin-tab:hover {
    color: var(--text);
}

.admin-tab.active {
    background: var(--surface);
    color: var(--primary);
    box-shadow: var(--shadow-sm);
}

.admin-content {
    display: none;
}

.admin-content.active {
    display: block;
}

/* Stats Cards */
.admin-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.admin-stat-card {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 20px;
    border: 1px solid var(--border);
}

.admin-stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
}

.admin-stat-label {
    font-size: 14px;
    color: var(--text-muted);
}

/* User Cards */
.user-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.user-card {
    background: var(--surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    overflow: hidden;
    transition: all 0.2s;
}

.user-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--primary);
}

.user-card-header {
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 1px solid var(--border);
}

.user-avatar {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 600;
    color: white;
}

.user-avatar.admin {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.user-avatar.analyst {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.user-avatar.owner {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.user-avatar.subscriber {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
}

.user-info h3 {
    margin: 0 0 4px 0;
    font-size: 16px;
    font-weight: 600;
}

.user-info p {
    margin: 0;
    font-size: 13px;
    color: var(--text-muted);
}

.user-card-body {
    padding: 20px;
}

.user-detail {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 14px;
}

.user-detail-label {
    color: var(--text-muted);
}

.user-detail-value {
    font-weight: 500;
}

.user-card-footer {
    padding: 16px 20px;
    background: var(--bg-alt);
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.user-card-footer .btn {
    flex: 1;
    min-width: 80px;
}

/* Assignment Section */
.assignment-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    margin-bottom: 24px;
}

.assignment-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.assignment-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.assignment-filters {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    background: var(--bg-alt);
    border-bottom: 1px solid var(--border);
}

.assignment-filters select,
.assignment-filters input {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 14px;
    background: var(--surface);
}

.assignment-table {
    width: 100%;
}

.assignment-table th {
    text-align: left;
    padding: 12px 20px;
    font-size: 12px;
    text-transform: uppercase;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    background: var(--bg-alt);
}

.assignment-table td {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}

.assignment-table tr:hover {
    background: var(--bg-alt);
}

.assignment-select {
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 13px;
    background: var(--surface);
    min-width: 150px;
}

/* Create User Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--surface);
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    font-size: 14px;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 14px;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

/* Role Colors */
.role-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.role-badge.admin {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.role-badge.analyst {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}

.role-badge.owner {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

.role-badge.subscriber {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
}

.status-active {
    color: #10b981;
}

.status-inactive {
    color: #ef4444;
}

/* Bulk Actions */
.bulk-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 16px 20px;
    background: var(--primary);
    color: white;
    border-radius: var(--radius-md);
    margin-bottom: 16px;
}

.bulk-actions.hidden {
    display: none;
}

.bulk-actions span {
    flex: 1;
}

.bulk-actions .btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
}
</style>

<div class="admin-header">
    <div>
        <h1 class="page-title">Admin Panel</h1>
        <p class="page-subtitle">Manage users, permissions, and case assignments</p>
    </div>
</div>

<!-- Stats -->
<div class="admin-stats">
    <div class="admin-stat-card">
        <div class="admin-stat-value">{{ stats.total_users }}</div>
        <div class="admin-stat-label">Total Users</div>
    </div>
    <div class="admin-stat-card">
        <div class="admin-stat-value">{{ stats.active_users }}</div>
        <div class="admin-stat-label">Active Users</div>
    </div>
    <div class="admin-stat-card">
        <div class="admin-stat-value">{{ stats.total_cases }}</div>
        <div class="admin-stat-label">Total Cases</div>
    </div>
    <div class="admin-stat-card">
        <div class="admin-stat-value">{{ stats.unassigned_cases }}</div>
        <div class="admin-stat-label">Unassigned Cases</div>
    </div>
</div>

<!-- Tabs -->
<div class="admin-tabs">
    <button class="admin-tab active" onclick="showTab('users')">üë• Users</button>
    <button class="admin-tab" onclick="showTab('assignments')">üìã Case Assignments</button>
    <button class="admin-tab" onclick="showTab('roles')">üîê Role Permissions</button>
</div>

<!-- Users Tab -->
<div id="tab-users" class="admin-content active">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 18px;">User Accounts</h2>
        <button class="btn btn-primary" onclick="openCreateUserModal()">
            <span>‚ûï</span> Create User
        </button>
    </div>
    
    <div class="user-grid">
        {% for user in users %}
        <div class="user-card">
            <div class="user-card-header">
                <div class="user-avatar {{ user.role }}">
                    {{ (user.full_name or user.email)[0]|upper }}
                </div>
                <div class="user-info">
                    <h3>{{ user.full_name or 'Unnamed User' }}</h3>
                    <p>{{ user.email }}</p>
                </div>
            </div>
            <div class="user-card-body">
                <div class="user-detail">
                    <span class="user-detail-label">Role</span>
                    <span class="role-badge {{ user.role }}">{{ user.role|title }}</span>
                </div>
                <div class="user-detail">
                    <span class="user-detail-label">Status</span>
                    <span class="{{ 'status-active' if user.is_active else 'status-inactive' }}">
                        {{ '‚óè Active' if user.is_active else '‚óã Inactive' }}
                    </span>
                </div>
                <div class="user-detail">
                    <span class="user-detail-label">Assigned Cases</span>
                    <span class="user-detail-value">{{ user.assigned_count or 0 }}</span>
                </div>
                <div class="user-detail">
                    <span class="user-detail-label">Last Login</span>
                    <span class="user-detail-value">{{ user.last_login or 'Never' }}</span>
                </div>
            </div>
            <div class="user-card-footer">
                <button class="btn btn-secondary btn-sm" onclick="openEditUserModal({{ user.id }}, '{{ user.email }}', '{{ user.full_name }}', '{{ user.role }}')">
                    ‚úèÔ∏è Edit
                </button>
                {% if user.id != current_user.id %}
                <button class="btn btn-secondary btn-sm" onclick="toggleUserStatus({{ user.id }}, {{ 'true' if user.is_active else 'false' }})">
                    {{ 'üîí Disable' if user.is_active else 'üîì Enable' }}
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteUser({{ user.id }}, '{{ user.email }}')">
                    üóëÔ∏è
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Assignments Tab -->
<div id="tab-assignments" class="admin-content">
    <div class="assignment-section">
        <div class="assignment-header">
            <h3>üìã Case Assignments</h3>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary btn-sm" onclick="bulkAssign()">Bulk Assign Selected</button>
            </div>
        </div>
        
        <div class="assignment-filters">
            <select id="filter-assigned" onchange="filterAssignments()">
                <option value="">All Cases</option>
                <option value="unassigned">Unassigned Only</option>
                <option value="assigned">Assigned Only</option>
            </select>
            <input type="text" id="filter-search" placeholder="Search cases..." onkeyup="filterAssignments()">
        </div>
        
        <div id="bulk-actions" class="bulk-actions hidden">
            <span><strong id="selected-count">0</strong> cases selected</span>
            <select id="bulk-assign-user">
                <option value="">Select User...</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.full_name or user.email }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-sm" onclick="applyBulkAssign()">Assign</button>
            <button class="btn btn-sm" onclick="clearSelection()">Cancel</button>
        </div>
        
        <table class="assignment-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                    </th>
                    <th>Case Number</th>
                    <th>Address</th>
                    <th>Filed</th>
                    <th style="width: 200px;">Assigned To</th>
                </tr>
            </thead>
            <tbody id="assignment-tbody">
                {% for case in cases %}
                <tr data-case-id="{{ case.id }}" data-assigned="{{ case.assigned_to or '' }}">
                    <td>
                        <input type="checkbox" class="case-checkbox" value="{{ case.id }}" onchange="updateSelection()">
                    </td>
                    <td>
                        <a href="/cases/{{ case.id }}" style="color: var(--primary); font-weight: 500;">
                            {{ case.case_number or 'Case #' + case.id|string }}
                        </a>
                    </td>
                    <td>{{ case.address_override or case.address or '‚Äî' }}</td>
                    <td>{{ case.filing_datetime or '‚Äî' }}</td>
                    <td>
                        <select class="assignment-select" onchange="assignCase({{ case.id }}, this.value)">
                            <option value="">Unassigned</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {{ 'selected' if case.assigned_to == user.id else '' }}>
                                {{ user.full_name or user.email }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Roles Tab -->
<div id="tab-roles" class="admin-content">
    <div class="assignment-section">
        <div class="assignment-header">
            <h3>üîê Role Permissions</h3>
        </div>
        <table class="assignment-table">
            <thead>
                <tr>
                    <th>Permission</th>
                    <th style="text-align: center;">Admin</th>
                    <th style="text-align: center;">Analyst</th>
                    <th style="text-align: center;">Owner</th>
                    <th style="text-align: center;">Subscriber</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>View All Cases</strong><br><small style="color: var(--text-muted);">See cases regardless of assignment</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                </tr>
                <tr>
                    <td><strong>View Assigned Cases</strong><br><small style="color: var(--text-muted);">See only cases assigned to them</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                </tr>
                <tr>
                    <td><strong>View Unassigned Cases</strong><br><small style="color: var(--text-muted);">See cases not assigned to anyone</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                </tr>
                <tr>
                    <td><strong>Edit Cases</strong><br><small style="color: var(--text-muted);">Modify case data, add notes</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                </tr>
                <tr>
                    <td><strong>Create Cases</strong><br><small style="color: var(--text-muted);">Add new cases to system</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                </tr>
                <tr>
                    <td><strong>Delete Cases</strong><br><small style="color: var(--text-muted);">Remove cases permanently</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                </tr>
                <tr>
                    <td><strong>Manage Users</strong><br><small style="color: var(--text-muted);">Create/edit/delete user accounts</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                </tr>
                <tr>
                    <td><strong>Assign Cases</strong><br><small style="color: var(--text-muted);">Assign cases to users</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                </tr>
                <tr>
                    <td><strong>View Reports</strong><br><small style="color: var(--text-muted);">Access analytics and reports</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                </tr>
                <tr>
                    <td><strong>Run Skip Trace</strong><br><small style="color: var(--text-muted);">Execute skip trace lookups</small></td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #10b981;">‚úì</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                    <td style="text-align: center; color: #ef4444;">‚úó</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Create User</h3>
            <button class="modal-close" onclick="closeUserModal()">&times;</button>
        </div>
        <form id="userForm" onsubmit="saveUser(event)">
            <div class="modal-body">
                <input type="hidden" id="user-id" name="user_id" value="">
                
                <div class="form-group">
                    <label for="user-email">Email Address *</label>
                    <input type="email" id="user-email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="user-name">Full Name *</label>
                    <input type="text" id="user-name" name="full_name" required>
                </div>
                
                <div class="form-group" id="password-group">
                    <label for="user-password">Password *</label>
                    <input type="password" id="user-password" name="password" minlength="8">
                    <div class="form-hint">Minimum 8 characters. Leave blank to keep existing password (edit mode).</div>
                </div>
                
                <div class="form-group">
                    <label for="user-role">Role *</label>
                    <select id="user-role" name="role" required>
                        <option value="analyst">Analyst - Can view/edit assigned cases</option>
                        <option value="owner">Owner - Can view/edit assigned cases</option>
                        <option value="subscriber">Subscriber - Read-only access to assigned cases</option>
                        <option value="admin">Admin - Full access to everything</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save User</button>
            </div>
        </form>
    </div>
</div>

<script>
// Tab switching
function showTab(tabName) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

// User Modal
function openCreateUserModal() {
    document.getElementById('modal-title').textContent = 'Create User';
    document.getElementById('user-id').value = '';
    document.getElementById('user-email').value = '';
    document.getElementById('user-name').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-password').required = true;
    document.getElementById('user-role').value = 'analyst';
    document.getElementById('userModal').classList.add('active');
}

function openEditUserModal(id, email, name, role) {
    document.getElementById('modal-title').textContent = 'Edit User';
    document.getElementById('user-id').value = id;
    document.getElementById('user-email').value = email;
    document.getElementById('user-name').value = name;
    document.getElementById('user-password').value = '';
    document.getElementById('user-password').required = false;
    document.getElementById('user-role').value = role;
    document.getElementById('userModal').classList.add('active');
}

function closeUserModal() {
    document.getElementById('userModal').classList.remove('active');
}

async function saveUser(e) {
    e.preventDefault();
    
    const userId = document.getElementById('user-id').value;
    const isEdit = !!userId;
    
    const data = {
        email: document.getElementById('user-email').value,
        full_name: document.getElementById('user-name').value,
        role: document.getElementById('user-role').value,
    };
    
    const password = document.getElementById('user-password').value;
    if (password) {
        data.password = password;
    }
    
    try {
        const url = isEdit ? `/api/admin/users/${userId}` : '/api/admin/users';
        const response = await fetch(url, {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            closeUserModal();
            location.reload();
        } else {
            alert(result.detail || 'Failed to save user');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function toggleUserStatus(userId, currentlyActive) {
    const action = currentlyActive ? 'disable' : 'enable';
    if (!confirm(`Are you sure you want to ${action} this user?`)) return;
    
    try {
        const response = await fetch(`/api/admin/users/${userId}/toggle-status`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const result = await response.json();
            alert(result.detail || 'Failed to update user');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteUser(userId, email) {
    if (!confirm(`Are you sure you want to delete user "${email}"? This cannot be undone.`)) return;
    
    try {
        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const result = await response.json();
            alert(result.detail || 'Failed to delete user');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Case Assignment
async function assignCase(caseId, userId) {
    try {
        const response = await fetch(`/api/admin/cases/${caseId}/assign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId || null })
        });
        
        if (!response.ok) {
            const result = await response.json();
            alert(result.detail || 'Failed to assign case');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Bulk Selection
function toggleSelectAll() {
    const checked = document.getElementById('select-all').checked;
    document.querySelectorAll('.case-checkbox').forEach(cb => cb.checked = checked);
    updateSelection();
}

function updateSelection() {
    const checked = document.querySelectorAll('.case-checkbox:checked');
    document.getElementById('selected-count').textContent = checked.length;
    document.getElementById('bulk-actions').classList.toggle('hidden', checked.length === 0);
}

function clearSelection() {
    document.querySelectorAll('.case-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    updateSelection();
}

async function applyBulkAssign() {
    const userId = document.getElementById('bulk-assign-user').value;
    if (!userId) {
        alert('Please select a user');
        return;
    }
    
    const caseIds = Array.from(document.querySelectorAll('.case-checkbox:checked')).map(cb => cb.value);
    
    try {
        const response = await fetch('/api/admin/cases/bulk-assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ case_ids: caseIds, user_id: userId })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const result = await response.json();
            alert(result.detail || 'Failed to assign cases');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Filter assignments
function filterAssignments() {
    const assignedFilter = document.getElementById('filter-assigned').value;
    const searchFilter = document.getElementById('filter-search').value.toLowerCase();
    
    document.querySelectorAll('#assignment-tbody tr').forEach(row => {
        const assigned = row.dataset.assigned;
        const text = row.textContent.toLowerCase();
        
        let show = true;
        
        if (assignedFilter === 'unassigned' && assigned) show = false;
        if (assignedFilter === 'assigned' && !assigned) show = false;
        if (searchFilter && !text.includes(searchFilter)) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

// Close modal on outside click
document.getElementById('userModal').addEventListener('click', function(e) {
    if (e.target === this) closeUserModal();
});
</script>
{% endblock %}
