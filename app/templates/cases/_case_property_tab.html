{# app/templates/cases/_case_property_tab.html #}

<div id="tab-property" class="tab-content">
  <section class="property-tab">
    <h3>
      Property Profile
      <a href="#" onclick="togglePropertyEdit(true); return false;" class="inline-edit-link">edit</a>
    </h3>

    {% if property_error %}
      <p class="property-error">{{ property_error }}</p>
    {% endif %}

    {% set ov = property_overrides or {} %}

    <div id="propertyEdit" style="display:none; margin:0.5rem 0 1rem 0;">
      <form method="post" action="/cases/{{ case.id }}/property-overrides">
        <div class="grid">
          <div>
            <label>Property Type</label>
            <input type="text" name="property_type" value="{{ ov.get('property_type','') }}">
          </div>
          <div>
            <label>Year Built</label>
            <input type="text" name="year_built" value="{{ ov.get('year_built','') }}">
          </div>
          <div>
            <label>Square Footage</label>
            <input type="text" name="sqft" value="{{ ov.get('sqft','') }}">
          </div>
          <div>
            <label>Lot Size</label>
            <input type="text" name="lot_size" value="{{ ov.get('lot_size','') }}">
          </div>
          <div>
            <label>Beds</label>
            <input type="text" name="beds" value="{{ ov.get('beds','') }}">
          </div>
          <div>
            <label>Baths</label>
            <input type="text" name="baths" value="{{ ov.get('baths','') }}">
          </div>
          <div>
            <label>Low Range</label>
            <input type="text" name="low_range" value="{{ ov.get('low_range','') }}">
          </div>
          <div>
            <label>High Range</label>
            <input type="text" name="high_range" value="{{ ov.get('high_range','') }}">
          </div>
          <div>
            <label>Estimated Value (AVM)</label>
            <input type="text" name="estimated_value" value="{{ ov.get('estimated_value','') }}">
          </div>
          <div>
            <label>Assessed Value</label>
            <input type="text" name="assessed_value" value="{{ ov.get('assessed_value','') }}">
          </div>
          <div>
            <label>Annual Taxes</label>
            <input type="text" name="annual_taxes" value="{{ ov.get('annual_taxes','') }}">
          </div>
        </div>
        <div style="margin-top:0.5rem;">
          <button class="btn" type="submit">Save</button>
          <button class="btn" type="button" onclick="togglePropertyEdit(false)">Cancel</button>
        </div>
      </form>
    </div>

    {% if property_data and property_data.get('results') and property_data['results'].get('properties') %}
      {% set props = property_data['results']['properties'] %}
      {% set p = props[0] %}

      {# Normalize nested dicts so missing keys don't explode #}
      {% set addr          = p.get('address')          or {} %}
      {% set valuation     = p.get('valuation')        or {} %}
      {% set assessment    = p.get('assessment')       or {} %}
      {% set tax           = p.get('tax')              or {} %}
      {% set general       = p.get('general')          or {} %}
      {% set lot           = p.get('lot')              or {} %}
      {% set building      = p.get('building')         or {} %}
      {% set listing       = p.get('listing')          or {} %} 
      {% set open_lien     = p.get('openLien')         or {} %}
      {% set mortgage_hist = p.get('mortgageHistory')  or [] %}
      {% set owner         = p.get('owner')            or {} %}
      {% set owner_mail    = owner.get('mailingAddress') or {} %}
      {% set quick         = p.get('quickLists')       or {} %}
      {% set meta          = p.get('meta')             or {} %}

      <div class="prop-grid">
        <!-- Card 1: Address & Basic Info -->
        <div class="prop-card">
          <h4>Address &amp; Basic Info</h4>

          <p>
            <strong>Street:</strong>
            {% if addr.street is defined %}
              {{ addr.street }}
            {% elif addr.streetNoUnit is defined %}
              {{ addr.streetNoUnit }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>City / State:</strong>
            {% if addr.city is defined or addr.state is defined %}
              {{ addr.city or '' }}{% if addr.city and addr.state %}, {% endif %}{{ addr.state or '' }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>ZIP:</strong>
            {% if addr.zip is defined %}
              {{ addr.zip }}{% if addr.zipPlus4 is defined %}-{{ addr.zipPlus4 }}{% endif %}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>County:</strong>
            {% if addr.county is defined %}
              {{ addr.county }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Latitude / Longitude:</strong>
            {% if addr.latitude is defined and addr.longitude is defined %}
              {{ '%.6f'|format(addr.latitude) }}, {{ '%.6f'|format(addr.longitude) }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Property Type:</strong>
            {% if ov.get('property_type') %}
              {{ ov.get('property_type') }}
            {% elif general.propertyTypeDetail is defined and general.propertyTypeDetail %}
              {{ general.propertyTypeDetail }}
            {% elif general.propertyTypeCategory is defined and general.propertyTypeCategory %}
              {{ general.propertyTypeCategory }}
            {% elif listing.propertyType is defined and listing.propertyType %}
              {{ listing.propertyType }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Year Built:</strong>
            {% if ov.get('year_built') %}
              {{ ov.get('year_built') }}
            {% elif general.yearBuilt is defined %}
              {{ general.yearBuilt }}
            {% elif p.yearBuilt is defined %}
              {{ p.yearBuilt }}
            {% elif listing.yearBuilt is defined %}
              {{ listing.yearBuilt }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Square Footage (Living):</strong>
            {% if ov.get('sqft') %}
              {{ ov.get('sqft') }}
            {% elif building.livingAreaSqft is defined %}
              {{ '{:,.0f}'.format(building.livingAreaSqft) }}
            {% elif general.buildingAreaSqft is defined %}
              {{ '{:,.0f}'.format(general.buildingAreaSqft) }}
            {% elif listing.totalBuildingAreaSquareFeet is defined %}
              {{ '{:,.0f}'.format(listing.totalBuildingAreaSquareFeet) }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Lot Size:</strong>
            {% if ov.get('lot_size') %}
              {{ ov.get('lot_size') }}
            {% elif lot.lotSizeAcres is defined %}
              {{ '%.3f'|format(lot.lotSizeAcres) }} acres
            {% elif lot.lotSizeSqft is defined %}
              {{ '{:,.0f}'.format(lot.lotSizeSqft) }} sqft
            {% elif listing.lotSizeSquareFeet is defined %}
              {{ '{:,.0f}'.format(listing.lotSizeSquareFeet) }} sqft
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Beds / Baths:</strong>
            {% if ov.get('beds') or ov.get('baths') %}
              {{ ov.get('beds') }} BR / {{ ov.get('baths') }} BA
            {% elif building.bedrooms is defined or building.totalBathrooms is defined %}
              {{ building.bedrooms or '???' }} BR / {{ building.totalBathrooms or '???' }} BA
            {% elif listing.bedroomCount is defined or listing.bathroomCount is defined %}
              {{ listing.bedroomCount or '???' }} BR / {{ listing.bathroomCount or '???' }} BA
            {% else %}
              ???
            {% endif %}
          </p>
        </div>

        <!-- Card 2: Valuation & Tax -->
        <div class="prop-card">
          <h4>Valuation &amp; Tax</h4>

          <p>
            <strong>Estimated Value (AVM):</strong>
            {% if ov.get('estimated_value') %}
              ${{ ov.get('estimated_value') }}
            {% elif valuation.estimatedValue is defined %}
              ${{ '{:,.0f}'.format(valuation.estimatedValue) }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Low / High Range:</strong>
            {% if ov.get('low_range') or ov.get('high_range') %}
              {% if ov.get('low_range') %}
                ${{ ov.get('low_range') }}
              {% else %}
                ??"
              {% endif %}
              ??"
              {% if ov.get('high_range') %}
                ${{ ov.get('high_range') }}
              {% else %}
                ??"
              {% endif %}
            {% elif valuation.lowRangeValue is defined or valuation.highRangeValue is defined %}
              {% if valuation.lowRangeValue is defined %}
                ${{ '{:,.0f}'.format(valuation.lowRangeValue) }}
              {% else %}
                ???
              {% endif %}
              ???
              {% if valuation.highRangeValue is defined %}
                ${{ '{:,.0f}'.format(valuation.highRangeValue) }}
              {% else %}
                ???
              {% endif %}
            {% elif listing.minListPrice is defined or listing.maxListPrice is defined %}
              {% if listing.minListPrice is defined %}
                ${{ '{:,.0f}'.format(listing.minListPrice) }}
              {% else %}
                ???
              {% endif %}
              ???
              {% if listing.maxListPrice is defined %}
                ${{ '{:,.0f}'.format(listing.maxListPrice) }}
              {% else %}
                ???
              {% endif %}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Confidence Score:</strong>
            {% if valuation.confidenceScore is defined %}
              {{ valuation.confidenceScore }}%
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Assessed Value:</strong>
            {% if ov.get('assessed_value') %}
              ${{ ov.get('assessed_value') }}
            {% elif assessment.totalAssessedValue is defined %}
              ${{ '{:,.0f}'.format(assessment.totalAssessedValue) }}
              {% if assessment.assessmentYear is defined %}
                (Tax Year {{ assessment.assessmentYear }})
              {% endif %}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Annual Taxes:</strong>
            {% if ov.get('annual_taxes') %}
              ${{ ov.get('annual_taxes') }}
            {% elif tax.taxAmount is defined %}
              ${{ '{:,.0f}'.format(tax.taxAmount) }}
              {% if tax.taxYear is defined %}
                (Tax Year {{ tax.taxYear }})
              {% endif %}
            {% else %}
              ???
            {% endif %}
          </p>
        </div>

        <!-- Card 3: Liens & Mortgages -->
        <div class="prop-card">
          <h4>Liens &amp; Mortgages</h4>

          <p>
            <strong>Total Open Liens:</strong>
            {% if open_lien.totalOpenLienBalance is defined %}
              ${{ '{:,.0f}'.format(open_lien.totalOpenLienBalance) }}
              {% if open_lien.totalOpenLienCount is defined %}
                ({{ open_lien.totalOpenLienCount }} loans)
              {% endif %}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Loan Types:</strong>
            {% if open_lien.allLoanTypes is defined and open_lien.allLoanTypes %}
              {{ open_lien.allLoanTypes|join(', ') }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Most Recent Mortgage:</strong>
            {% if mortgage_hist and mortgage_hist|length > 0 %}
              {% set m = mortgage_hist[0] %}
              {% if m.originalLoanAmount is defined %}
                ${{ '{:,.0f}'.format(m.originalLoanAmount) }}
              {% else %}
                ???
              {% endif %}
              {% if m.loanType is defined and m.loanType %}
                ({{ m.loanType }})
              {% endif %}
              {% if m.recordingDate is defined and m.recordingDate %}
                <br><small>Recorded: {{ m.recordingDate[:10] }}</small>
              {% endif %}
            {% else %}
              ???
            {% endif %}
          </p>
        </div>

        <!-- Card 4: Owner & Flags -->
        <div class="prop-card">
          <h4>Owner &amp; Flags</h4>

          <p>
            <strong>Owner:</strong>
            {% if owner.fullName is defined and owner.fullName %}
              {{ owner.fullName }}
            {% elif owner.names is defined and owner.names %}
              {{ owner.names[0].full or owner.names[0].first }}
            {% else %}
              ???
            {% endif %}
          </p>

          <p>
            <strong>Mailing Address:</strong>
            {% if owner_mail.street is defined %}
              {{ owner_mail.street }},
              {{ owner_mail.city }},
              {{ owner_mail.state }}
              {{ owner_mail.zip }}
            {% else %}
              ???
            {% endif %}
          </p>

          {# QuickList tags #}
          {% set tags = [] %}
          {% if quick.ownerOccupied %}{% set _ = tags.append('Owner Occupied') %}{% endif %}
          {% if quick.highEquity %}{% set _ = tags.append('High Equity') %}{% endif %}
          {% if quick.freeAndClear %}{% set _ = tags.append('Free & Clear') %}{% endif %}
          {% if quick.absenteeOwner %}{% set _ = tags.append('Absentee Owner') %}{% endif %}
          {% if quick.preforeclosure %}{% set _ = tags.append('Pre-foreclosure') %}{% endif %}
          {% if quick.taxDefault %}{% set _ = tags.append('Tax Default') %}{% endif %}
          {% if quick.vacant %}{% set _ = tags.append('Vacant') %}{% endif %}
          {% if quick.hasHoa %}{% set _ = tags.append('Has HOA') %}{% endif %}

          {% if tags %}
            <p><strong>Quick Flags:</strong></p>
            <p>
              {% for t in tags %}
                <span class="pill pill-tag">{{ t }}</span>
              {% endfor %}
            </p>
          {% endif %}

          {% if meta.propertyDateModified is defined %}
            <p><small>Last Updated: {{ meta.propertyDateModified[:10] }}</small></p>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="prop-grid">
        <div class="prop-card">
          <h4>Manual Property Data</h4>
          <p><strong>Property Type:</strong> {{ ov.get('property_type','') or '???' }}</p>
          <p><strong>Year Built:</strong> {{ ov.get('year_built','') or '???' }}</p>
          <p><strong>Square Footage:</strong> {{ ov.get('sqft','') or '???' }}</p>
          <p><strong>Lot Size:</strong> {{ ov.get('lot_size','') or '???' }}</p>
          <p><strong>Beds:</strong> {{ ov.get('beds','') or '???' }}</p>
          <p><strong>Baths:</strong> {{ ov.get('baths','') or '???' }}</p>
          <p><strong>Low Range:</strong> {{ ov.get('low_range','') or '???' }}</p>
          <p><strong>High Range:</strong> {{ ov.get('high_range','') or '???' }}</p>
          <p><strong>Estimated Value (AVM):</strong> {{ ov.get('estimated_value','') or '???' }}</p>
          <p><strong>Assessed Value:</strong> {{ ov.get('assessed_value','') or '???' }}</p>
          <p><strong>Annual Taxes:</strong> {{ ov.get('annual_taxes','') or '???' }}</p>
        </div>
      </div>

      <p><em>No BatchData property results stored yet for this case.</em></p>
    {% endif %}

  </section>
</div>









