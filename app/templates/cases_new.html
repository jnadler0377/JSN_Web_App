{% extends "base.html" %}
{% block title %}Add New Case - JSN Holdings{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Add New Case</h1>
    <p class="page-subtitle">Enter the case details to add it to your pipeline.</p>
</div>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<div class="card">
    <div class="card-body">
        <form action="/cases/create" method="post">
            <div class="form-row" style="margin-bottom: var(--space-lg);">
                <div class="form-group">
                    <label class="form-label">Case # *</label>
                    <input type="text" name="case_number" required placeholder="e.g., 51-2025-CA-001234-ES" class="form-control">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Filing Date</label>
                    <input type="date" name="filing_date" class="form-control">
                    <span class="form-hint">Optional. If empty, will be left blank.</span>
                </div>
            </div>
            
            <div class="form-row" style="margin-bottom: var(--space-lg);">
                <div class="form-group">
                    <label class="form-label">Style / Case Name</label>
                    <input type="text" name="style" placeholder="Plaintiff v. Defendant" class="form-control">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel ID</label>
                    <input type="text" name="parcel_id" placeholder="33-24-16-0260-00000-2540" class="form-control">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: var(--space-lg);">
                <label class="form-label">Address</label>
                <input type="text" name="address_override" placeholder="123 Main St, Hudson, FL 34667" class="form-control">
            </div>
            
            <h3 style="margin-top: var(--space-xl); margin-bottom: var(--space-lg); padding-bottom: var(--space-sm); border-bottom: 1px solid var(--border);">Property Details</h3>
            
            <div class="form-row" style="margin-bottom: var(--space-lg);">
                <div class="form-group">
                    <label class="form-label">ARV</label>
                    <input id="new-arv" type="number" inputmode="decimal" name="arv" step="0.01" min="0" placeholder="0.00" class="form-control">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Year Built</label>
                    <input id="new-year-built" type="number" inputmode="numeric" name="year_built" step="1" min="1800" max="2100" placeholder="e.g., 1998" class="form-control">
                </div>
            </div>
            
            <div class="form-row" style="margin-bottom: var(--space-lg);">
                <div class="form-group">
                    <label class="form-label">Living Sq Ft</label>
                    <input id="new-living-sqft" type="number" inputmode="numeric" name="living_sqft" step="1" min="0" placeholder="e.g., 1750" class="form-control">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rehab Estimate</label>
                    <input id="new-rehab" type="number" inputmode="decimal" name="rehab" step="0.01" min="0" placeholder="Suggested Rehab $0.00" class="form-control">
                </div>
            </div>
            
            <div class="form-row" style="margin-bottom: var(--space-lg);">
                <div class="form-group">
                    <label class="form-label">Condition</label>
                    <div style="display: flex; gap: var(--space-lg); margin-top: var(--space-sm);">
                        <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer; font-weight: 400;">
                            <input type="radio" name="rehab_condition" value="Poor" style="width: 18px; height: 18px;">
                            <span>Poor</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer; font-weight: 400;">
                            <input type="radio" name="rehab_condition" value="Fair" style="width: 18px; height: 18px;">
                            <span>Fair</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer; font-weight: 400;">
                            <input type="radio" name="rehab_condition" value="Good" checked style="width: 18px; height: 18px;">
                            <span>Good</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer; font-weight: 400;">
                            <input type="radio" name="rehab_condition" value="Excellent" style="width: 18px; height: 18px;">
                            <span>Excellent</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Closing Costs</label>
                    <input id="new-closing-costs" type="number" inputmode="decimal" name="closing_costs" step="0.01" min="0" placeholder="Suggested Closing Costs $0.00" class="form-control">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: var(--space-xl);">
                <label class="form-label">Defendants</label>
                <textarea name="defendants_csv" rows="3" placeholder="John A. Smith&#10;Jane Q. Doe" class="form-control" style="min-height: 100px;"></textarea>
                <span class="form-hint">Enter one defendant per line or comma-separated.</span>
            </div>
            
            <div style="display: flex; gap: var(--space-md); padding-top: var(--space-lg); border-top: 1px solid var(--border);">
                <button type="submit" class="btn btn-primary btn-lg">Create Case</button>
                <a href="/cases" class="btn btn-secondary btn-lg">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const arvInput = document.getElementById('new-arv');
    const closingInput = document.getElementById('new-closing-costs');
    const yearInput = document.getElementById('new-year-built');
    const sqftInput = document.getElementById('new-living-sqft');
    const rehabInput = document.getElementById('new-rehab');
    const conditionInputs = document.querySelectorAll('input[name="rehab_condition"]');
    if (!arvInput || !closingInput) return;

    function updateClosingPlaceholder() {
        const val = parseFloat(arvInput.value || '0');
        if (!val || isNaN(val)) {
            closingInput.placeholder = 'Suggested Closing Costs $0.00';
            return;
        }
        const suggested = (val * 0.015).toFixed(2);
        closingInput.placeholder = `Suggested Closing Costs $${Number(suggested).toLocaleString()}`;
    }

    arvInput.addEventListener('input', updateClosingPlaceholder);

    function currentCondition() {
        const checked = document.querySelector('input[name="rehab_condition"]:checked');
        return checked ? checked.value : 'Good';
    }

    function estimateRehab() {
        if (!yearInput || !sqftInput || !rehabInput) return;
        const year = parseInt(yearInput.value || '0', 10);
        const sqft = parseFloat(sqftInput.value || '0');
        if (!year || !sqft || isNaN(sqft)) {
            rehabInput.placeholder = 'Suggested Rehab $0.00';
            return;
        }
        let base = 20.0;
        if (year < 1960) base = 50.0;
        else if (year <= 1989) base = 40.0;
        else if (year <= 2009) base = 35.0;
        else if (year <= 2020) base = 30.0;
        else base = 20.0;

        const mults = { poor: 1.0, fair: 0.75, good: 0.60, excellent: 0.50 };
        const cond = currentCondition().toLowerCase();
        const mult = mults[cond] ?? 0.60;

        let estimate = base * sqft * mult;
        estimate = Math.max(12000, Math.min(120000, estimate));
        rehabInput.placeholder = `Suggested Rehab $${estimate.toLocaleString()}`;
    }

    if (yearInput) yearInput.addEventListener('input', estimateRehab);
    if (sqftInput) sqftInput.addEventListener('input', estimateRehab);
    conditionInputs.forEach((el) => el.addEventListener('change', estimateRehab));
})();
</script>
{% endblock %}
