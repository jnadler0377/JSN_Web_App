{% extends "base.html" %}
{% block title %}Comparables - {{ case.case_number }} - JSN Holdings{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
    <div>
        <h1 class="page-title">Comparable Sales</h1>
        <p class="page-subtitle">Case: {{ case.case_number }} ‚Ä¢ {{ (case.address_override or case.address)|title }}</p>
    </div>
    <div style="display: flex; gap: 8px;">
        <form method="POST" action="/cases/{{ case.id }}/fetch-comparables" style="display: inline;">
            <button type="submit" class="btn btn-primary">üîÑ Refresh Comparables</button>
        </form>
        <a href="/cases/{{ case.id }}" class="btn btn-secondary">‚Üê Back to Case</a>
    </div>
</div>

<!-- Suggested ARV Summary -->
{% if suggested_arv and suggested_arv > 0 %}
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h3 class="card-title">Suggested Valuation</h3>
    </div>
    <div class="card-body">
        <div class="stats-grid" style="margin-bottom: 0;">
            <div class="stat-card" style="margin: 0;">
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Suggested ARV</div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${{ "{:,.0f}".format(suggested_arv) }}</div>
            </div>
            <div class="stat-card" style="margin: 0;">
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Low Estimate</div>
                <div style="font-size: 28px; font-weight: 700;">${{ "{:,.0f}".format(low_estimate) }}</div>
            </div>
            <div class="stat-card" style="margin: 0;">
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">High Estimate</div>
                <div style="font-size: 28px; font-weight: 700;">${{ "{:,.0f}".format(high_estimate) }}</div>
            </div>
            <div class="stat-card" style="margin: 0;">
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Current ARV</div>
                <div style="font-size: 28px; font-weight: 700;">
                    {% if case.arv %}${{ "{:,.0f}".format(case.arv) }}{% else %}<span style="color: var(--text-muted);">Not set</span>{% endif %}
                </div>
            </div>
        </div>
        
        {% if suggested_arv and (not case.arv or case.arv != suggested_arv) %}
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
            <form method="POST" action="/cases/{{ case.id }}/update" style="display: inline;">
                <input type="hidden" name="arv" value="{{ suggested_arv }}">
                <button type="submit" class="btn btn-primary btn-sm">Apply Suggested ARV (${{ "{:,.0f}".format(suggested_arv) }})</button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Comparables Table -->
{% if comparables %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Recent Sales ({{ comparables|length }} found)</h3>
    </div>
    <div class="table-container" style="border: none; border-radius: 0;">
        <table class="table">
            <thead>
                <tr>
                    <th>Address</th>
                    <th>Sale Date</th>
                    <th>Sale Price</th>
                    <th>$/sqft</th>
                    <th>Beds</th>
                    <th>Baths</th>
                    <th>Sqft</th>
                    <th>Year Built</th>
                    <th>Distance</th>
                </tr>
            </thead>
            <tbody>
                {% for comp in comparables %}
                <tr>
                    <td>
                        <strong>{{ comp.comp_address }}</strong><br>
                        <span style="color: var(--text-muted); font-size: 13px;">{{ comp.comp_city }}, {{ comp.comp_state }} {{ comp.comp_zip }}</span>
                    </td>
                    <td>{{ comp.sale_date or '‚Äî' }}</td>
                    <td>
                        {% if comp.sale_price %}
                            <strong style="color: var(--success);">${{ "{:,.0f}".format(comp.sale_price) }}</strong>
                        {% else %}
                            <span style="color: var(--text-muted);">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if comp.price_per_sqft %}${{ "{:,.0f}".format(comp.price_per_sqft) }}{% else %}‚Äî{% endif %}
                    </td>
                    <td>{{ comp.bedrooms or '‚Äî' }}</td>
                    <td>{{ comp.bathrooms or '‚Äî' }}</td>
                    <td>{{ "{:,}".format(comp.sqft) if comp.sqft else '‚Äî' }}</td>
                    <td>{{ comp.year_built or '‚Äî' }}</td>
                    <td>
                        {% if comp.distance_miles %}
                            <span class="badge badge-neutral">{{ "%.2f"|format(comp.distance_miles) }} mi</span>
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% else %}

<!-- No Comparables Found -->
<div class="card">
    <div class="card-body" style="text-align: center; padding: 48px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üî≠</div>
        <h3 style="margin-bottom: 8px;">No Comparables Found</h3>
        <p style="color: var(--text-muted); margin-bottom: 24px;">
            Click "Refresh Comparables" above to fetch recent sales near this property.
        </p>
        <form method="POST" action="/cases/{{ case.id }}/fetch-comparables">
            <button type="submit" class="btn btn-primary btn-lg" id="fetch-btn">
                üîç Fetch Comparables
            </button>
        </form>
    </div>
</div>

{% endif %}
{% endblock %}
