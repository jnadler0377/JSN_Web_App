{% extends "base.html" %}
{% block title %}{{ case.case_number }} - JSN Holdings{% endblock %}

{% block extra_css %}
<style>
/* Case Detail Page Styles */
.case-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
    gap: var(--space-md);
}

.case-header-left h1 {
    font-size: 24px;
    margin-bottom: 4px;
}

.case-meta {
    display: flex;
    gap: var(--space-lg);
    color: var(--text-secondary);
    font-size: 14px;
    flex-wrap: wrap;
}

.case-actions {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
    align-items: center;
}

/* V3: Claim Status Banner */
.claim-status-banner {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-md);
    font-size: 14px;
    margin-right: var(--space-md);
}

.claim-status-banner.owned {
    background: var(--success-light);
    color: var(--success);
}

.claim-status-banner.claimed {
    background: var(--warning-light);
    color: #b45309;
}

.claim-status-banner.available {
    background: var(--info-light);
    color: var(--info);
}

/* Tabs */
.case-tabs {
    display: flex;
    gap: 4px;
    border-bottom: 2px solid var(--border);
    margin-bottom: var(--space-lg);
    overflow-x: auto;
}

.case-tab {
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: var(--transition);
    cursor: pointer;
    white-space: nowrap;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
}

.case-tab:hover {
    color: var(--text);
    background: var(--bg-alt);
}

.case-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.tab-content {
    display: none;
    animation: fadeIn 0.2s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Overview Grid */
.overview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
}

@media (max-width: 1024px) {
    .overview-grid {
        grid-template-columns: 1fr;
    }
}

.overview-left, .overview-right {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
}

/* Address & Street View */
.address-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.streetview-container {
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--bg-alt);
}

.streetview-img {
    width: 100%;
    height: 200px;
    object-fit: cover;
}

.streetview-placeholder {
    height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--text-muted);
}

/* Condition Chips */
.condition-chip {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    background: var(--bg-alt);
    border: 2px solid var(--border);
    border-radius: var(--radius-full);
    cursor: pointer;
    font-size: 14px;
    transition: var(--transition);
}

.condition-chip input {
    display: none;
}

.condition-chip.active,
.condition-chip:has(input:checked) {
    background: rgba(102, 126, 234, 0.1);
    border-color: var(--primary);
    color: var(--primary);
}

.condition-chip:hover {
    border-color: var(--primary);
}

/* Document Items */
.doc-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-light);
}

.doc-item:last-child {
    border-bottom: none;
}

/* Note Items */
.note-item {
    padding: 12px;
    background: var(--bg-alt);
    border-radius: var(--radius-md);
    margin-bottom: 8px;
}

.note-item:last-child {
    margin-bottom: 0;
}

/* Liens */
.lien-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg-alt);
    border-radius: var(--radius-md);
    margin-bottom: 8px;
}

.lien-item:last-child {
    margin-bottom: 0;
}

.lien-amount {
    font-weight: 600;
    color: var(--danger);
}

/* Lien Modal */
.lien-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.lien-modal.show {
    display: flex;
}

.lien-modal-content {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    width: 100%;
    max-width: 400px;
    box-shadow: var(--shadow-xl);
}

.lien-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.lien-modal-header h4 {
    margin: 0;
}

.lien-close {
    font-size: 24px;
    cursor: pointer;
    color: var(--text-muted);
}

.lien-close:hover {
    color: var(--text);
}

.lien-modal-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: flex-end;
    margin-top: var(--space-lg);
}

/* Property Tab Styles */
.property-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    border: 1px solid var(--border);
    margin-bottom: var(--space-lg);
}

.property-section h3 {
    margin: 0 0 var(--space-md) 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.property-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
}

.property-field {
    display: flex;
    flex-direction: column;
}

.property-field label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
}

.property-field .value {
    padding: 10px 12px;
    background: var(--bg-alt);
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    font-size: 14px;
}

.flag-badge {
    display: inline-block;
    padding: 4px 12px;
    background: var(--success-light);
    color: var(--success);
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 500;
    margin: 4px 4px 4px 0;
}

.flag-badge.false {
    background: var(--bg-alt);
    color: var(--text-muted);
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.history-table th,
.history-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.history-table th {
    background: var(--bg-alt);
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
}

.history-table tbody tr:hover {
    background: var(--bg-alt);
}

/* Deal Analysis Styles */
.deal-analysis-card {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    border: 1px solid var(--border);
}

.deal-analysis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.deal-analysis-header h4 {
    margin: 0;
    font-size: 16px;
}

.deal-score-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    border-radius: var(--radius-md);
    font-weight: 700;
}

.deal-score-badge.excellent {
    background: var(--success-light);
    color: var(--success);
}

.deal-score-badge.good {
    background: var(--info-light);
    color: var(--info);
}

.deal-score-badge.fair {
    background: var(--warning-light);
    color: #b45309;
}

.deal-score-badge.poor {
    background: var(--danger-light);
    color: var(--danger);
}

.deal-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.deal-metric {
    padding: var(--space-md);
    background: var(--bg-alt);
    border-radius: var(--radius-md);
    text-align: center;
}

.deal-metric-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
}

.deal-metric-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
}

.deal-metric-value.positive {
    color: var(--success);
}

.deal-metric-value.negative {
    color: var(--danger);
}

.deal-recommendations h5 {
    margin: 0 0 var(--space-sm) 0;
    font-size: 14px;
    color: var(--text-secondary);
}

.recommendation-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.recommendation-tag {
    display: inline-block;
    padding: 6px 12px;
    background: rgba(102, 126, 234, 0.1);
    color: var(--primary);
    border-radius: var(--radius-full);
    font-size: 13px;
}

.deal-analysis-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: var(--space-xl);
    color: var(--text-muted);
}

.spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.deal-analysis-error {
    background: var(--danger-light);
    color: var(--danger);
    padding: var(--space-lg);
    border-radius: var(--radius-md);
    text-align: center;
}

/* Skip Trace Styles */
.skip-person {
    padding: var(--space-md);
    background: var(--bg-alt);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
}

.skip-person:last-child {
    margin-bottom: 0;
}

.skip-section-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
}

/* Comparables */
.comp-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-md);
}

/* V3: Locked Content Overlay */
.locked-overlay {
    position: relative;
}

.locked-overlay::after {
    content: 'üîí Claim this case to view';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: var(--text-muted);
    border-radius: var(--radius-md);
}

.locked-content {
    filter: blur(4px);
    user-select: none;
    pointer-events: none;
}
</style>
{% endblock %}

{% block content %}
<!-- Case Header -->
<div class="case-header">
    <div class="case-header-left">
        <h1>{{ case.case_number }}</h1>
        <div class="case-meta">
            <span>üìç {{ (case.address_override or case.address or 'No address')|title }}</span>
            <span>üìÖ Filed: {{ case.filing_datetime or '‚Äî' }}</span>
            {% if case.style %}<span>‚öñÔ∏è {{ case.style }}</span>{% endif %}
        </div>
    </div>
    <div class="case-actions">
        <!-- V3: Claim Status and Action -->
        {% set is_owner = case.assigned_to == current_user.id if current_user else False %}
        {% set is_claimed = case.assigned_to is not none %}
        
        {% if is_owner %}
            <div class="claim-status-banner owned">
                <span>üîí You own this case</span>
                {% if claim_info %}
                    <span style="opacity: 0.8;">‚Ä¢ Score: {{ claim_info.score_at_claim }} ‚Ä¢ {{ claim_info.price_display }}/day</span>
                {% endif %}
            </div>
            <button class="btn btn-secondary" onclick="releaseCase({{ case.id }})">
                üîì Release Case
            </button>
        {% elif is_claimed %}
            <div class="claim-status-banner claimed">
                <span>üîí Claimed by another user</span>
            </div>
        {% else %}
            <div class="claim-status-banner available">
                <span>Available to claim</span>
            </div>
            <button class="btn btn-primary" onclick="claimCase({{ case.id }})" id="claim-btn">
                üîí Claim Case
            </button>
        {% endif %}
        
        {% if not has_property_data %}
        <form method="post" action="/cases/{{ case.id }}/property-lookup" style="display: inline;">
            <button type="submit" class="btn btn-secondary">üîç Fetch Property Data</button>
        </form>
        {% endif %}
        <a href="/cases/{{ case.id }}/comparables" class="btn btn-secondary">üìä Comparables</a>
        <button class="btn btn-secondary" onclick="generateCaseReport({{ case.id }})">üìÑ Generate Report</button>
        <a href="/cases" class="btn btn-ghost">‚Üê Back to Cases</a>
    </div>
</div>

<!-- Case Tabs -->
<div class="case-tabs">
    <button class="case-tab active" data-tab="overview">Overview</button>
    <button class="case-tab" data-tab="property">Property</button>
    <button class="case-tab" data-tab="documents">Documents</button>
    <button class="case-tab" data-tab="deal-analysis">Deal Analysis</button>
</div>

<!-- Tab Contents -->
<div id="tab-overview" class="tab-content active">
    {% include "cases/_case_overview_tab.html" %}
</div>

<div id="tab-property" class="tab-content">
    {% include "cases/_case_property_tab.html" %}
</div>

<div id="tab-documents" class="tab-content">
    {% include "cases/_case_documents_tab.html" %}
</div>

<div id="tab-deal-analysis" class="tab-content">
    {% include "cases/_deal_analysis_component.html" %}
</div>

<!-- Lien Modal -->
{% include "cases/_case_overview_lien_modal.html" %}

{% endblock %}

{% block extra_js %}
<script>
// Tab switching
document.querySelectorAll('.case-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabId = this.dataset.tab;
        document.querySelectorAll('.case-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
    });
});

// Address edit toggle
function toggleAddressEdit(show) {
    document.getElementById('addressEdit').style.display = show ? 'block' : 'none';
}

function toggleParcelEdit(show) {
    const el = document.getElementById('parcelEdit');
    if (el) el.style.display = show ? 'block' : 'none';
}

// ============================================================
// V3: CLAIM FUNCTIONALITY
// ============================================================

async function claimCase(caseId) {
    const btn = document.getElementById('claim-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Claiming...';
    }
    
    try {
        const response = await fetch(`/api/v3/cases/${caseId}/claim`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to claim case');
        }
        
        const result = await response.json();
        showToast(`Case claimed! Score: ${result.score}, ${result.price_display}/day`, 'success');
        
        // Reload page to show updated status
        setTimeout(() => window.location.reload(), 1000);
        
    } catch (err) {
        showToast(err.message, 'error');
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'üîí Claim Case';
        }
    }
}

async function releaseCase(caseId) {
    if (!confirm('Are you sure you want to release this case? You will lose exclusive access to the data.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v3/cases/${caseId}/release`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to release case');
        }
        
        const result = await response.json();
        showToast('Case released successfully', 'success');
        
        // Reload page to show updated status
        setTimeout(() => window.location.reload(), 1000);
        
    } catch (err) {
        showToast(err.message, 'error');
    }
}

// ============================================================
// CURRENCY FORMATTING
// ============================================================

function formatCurrencyInput(input) {
    let value = input.value.replace(/[^0-9.]/g, '');
    if (value) {
        const num = parseFloat(value);
        if (!isNaN(num)) {
            input.dataset.rawValue = num;
        }
    }
}

function setupCurrencyInputs() {
    const currencyInputs = document.querySelectorAll('input[name="arv"], input[name="rehab"], input[name="closing_costs"]');
    currencyInputs.forEach(input => {
        // Format on blur
        input.addEventListener('blur', function() {
            let value = this.value.replace(/[^0-9.]/g, '');
            if (value) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    this.value = '$' + num.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    this.dataset.rawValue = num;
                }
            }
        });
        // Clear formatting on focus
        input.addEventListener('focus', function() {
            let value = this.value.replace(/[^0-9.]/g, '');
            if (value) {
                this.value = value;
            }
        });
        // Format existing values on load
        if (input.value && !input.value.startsWith('$')) {
            const num = parseFloat(input.value);
            if (!isNaN(num) && num > 0) {
                input.value = '$' + num.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                input.dataset.rawValue = num;
            }
        }
    });
    
    // Before form submit, convert back to numbers
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function() {
            currencyInputs.forEach(input => {
                if (input.form === form) {
                    input.value = input.value.replace(/[^0-9.]/g, '');
                }
            });
        });
    });
}

// ============ LIEN MANAGEMENT ============
const CASE_ID = {{ case.id }};
let liens = [];

async function loadLiens() {
    try {
        const resp = await fetch(`/cases/${CASE_ID}/liens`);
        if (!resp.ok) {
            console.error('Failed to load liens, status:', resp.status);
            liens = [];
            renderLiens();
            return;
        }
        const data = await resp.json();
        // Clean to only holder and amount
        liens = Array.isArray(data) ? data.map(l => ({
            holder: l.holder || '',
            amount: l.amount || ''
        })) : [];
        console.log('Loaded liens:', liens);
        renderLiens();
    } catch (e) {
        console.error('Error loading liens:', e);
        liens = [];
        renderLiens();
    }
}

function renderLiens() {
    const container = document.getElementById('liens-list');
    if (!container) return;
    
    if (!liens || liens.length === 0) {
        container.innerHTML = '<div class="liens-empty-hint" style="padding: 16px; text-align: center; color: var(--text-muted);">No liens added yet.</div>';
        return;
    }
    
    let total = 0;
    let html = '';
    liens.forEach((lien, idx) => {
        // Handle amount as string or number
        const rawAmt = (lien.amount || '').toString().replace(/[^0-9.]/g, '');
        const amt = parseFloat(rawAmt) || 0;
        total += amt;
        html += `
            <div class="lien-item">
                <div>
                    <div style="font-weight: 500;">${escapeHtml(lien.holder || 'Unknown')}</div>
                    <div style="font-size: 13px; color: var(--text-muted);">Lien #${idx + 1}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="lien-amount">${formatCurrency(amt)}</span>
                    <button class="btn btn-ghost btn-sm" onclick="editLien(${idx})">Edit</button>
                    <button class="btn btn-ghost btn-sm" style="color: var(--danger);" onclick="deleteLien(${idx})">√ó</button>
                </div>
            </div>
        `;
    });
    
    html += `
        <div style="padding: 12px; background: var(--bg-alt); border-radius: var(--radius-md); margin-top: 8px; display: flex; justify-content: space-between;">
            <strong>Total Liens:</strong>
            <strong style="color: var(--danger);">${formatCurrency(total)}</strong>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Update summary if exists
    const totalEl = document.getElementById('summary-liens-total');
    if (totalEl) totalEl.textContent = formatCurrency(total);
}

function formatCurrency(amount) {
    return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function openLienModal(idx = null) {
    const modal = document.getElementById('lienModal');
    const title = document.getElementById('lienModalTitle');
    const indexField = document.getElementById('lienIndex');
    const holderField = document.getElementById('lienHolder');
    const amountField = document.getElementById('lienAmount');
    
    if (idx !== null && liens[idx]) {
        title.textContent = 'Edit Lien';
        indexField.value = idx;
        holderField.value = liens[idx].holder || '';
        amountField.value = liens[idx].amount || '';
    } else {
        title.textContent = 'Add Lien';
        indexField.value = '';
        holderField.value = '';
        amountField.value = '';
    }
    
    modal.classList.add('show');
}

function closeLienModal() {
    document.getElementById('lienModal').classList.remove('show');
}

function editLien(idx) {
    openLienModal(idx);
}

async function deleteLien(idx) {
    if (!confirm('Delete this lien?')) return;
    
    // Remove from local array
    liens.splice(idx, 1);
    
    // Save to server (this will reload and re-render)
    const success = await saveLiens();
    if (success) {
        showToast('Lien deleted', 'success');
    } else {
        // Reload to get original state back
        await loadLiens();
    }
}

async function saveLiens() {
    const saving = document.getElementById('liens-saving');
    if (saving) saving.style.display = 'block';
    
    try {
        // Clean liens to only include holder and amount (as strings)
        const cleanLiens = liens.map(l => ({
            holder: String(l.holder || ''),
            amount: String(l.amount || '')
        }));
        
        console.log('Saving liens:', JSON.stringify({ outstanding_liens: cleanLiens }));
        
        const resp = await fetch(`/cases/${CASE_ID}/liens`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ outstanding_liens: cleanLiens })
        });
        
        if (!resp.ok) {
            const errorText = await resp.text();
            console.error('Failed to save liens, status:', resp.status, 'response:', errorText);
            showToast('Failed to save liens', 'error');
            return false;
        }
        
        // Reload from server to get the saved state
        await loadLiens();
        return true;
    } catch (e) {
        console.error('Error saving liens:', e);
        showToast('Error saving liens: ' + e.message, 'error');
        return false;
    } finally {
        if (saving) saving.style.display = 'none';
    }
}

// Simple toast notification
function showToast(message, type = 'success') {
    const existing = document.querySelector('.toast-notification');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast-notification ' + type;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        background: ${type === 'error' ? '#ef4444' : '#10b981'};
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// Modal event listeners
document.getElementById('lien-modal-open')?.addEventListener('click', () => openLienModal());
document.getElementById('lienModalClose')?.addEventListener('click', closeLienModal);
document.getElementById('lienModalCancel')?.addEventListener('click', closeLienModal);

document.getElementById('lienModalForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const idx = document.getElementById('lienIndex').value;
    const holder = document.getElementById('lienHolder').value.trim();
    const amount = document.getElementById('lienAmount').value.trim();
    
    if (!holder || !amount) {
        showToast('Please enter both holder and amount', 'error');
        return;
    }
    
    const lienData = { holder, amount };
    
    // Update local array
    if (idx !== '') {
        liens[parseInt(idx)] = lienData;
    } else {
        liens.push(lienData);
    }
    
    // Save to server (this will also reload and re-render)
    const success = await saveLiens();
    if (success) {
        showToast('Lien saved successfully!', 'success');
        closeLienModal();
    } else {
        // Reload to get original state back
        await loadLiens();
    }
});

// Close modal on backdrop click
document.getElementById('lienModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeLienModal();
});

// Generate Case Report - use existing report service
async function generateCaseReport(caseId) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Generating...';
    
    // Use the existing report endpoint that generates the detailed PDF
    window.location.href = `/cases/${caseId}/report`;
    
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }, 2000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLiens();
    setupCurrencyInputs();
});
</script>
{% endblock %}
