{% extends "base.html" %}
{% block title %}Dashboard - JSN Holdings{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">Welcome back! Here's an overview of your foreclosure pipeline.</p>
</div>

<!-- Key Metrics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon purple">üìä</div>
        <div class="stat-value">{{ metrics.total_cases | default(0) }}</div>
        <div class="stat-label">Total Cases</div>
        <div class="stat-change positive">
            <span>+{{ metrics.new_cases_30d | default(0) }}</span> this month
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon green">üéØ</div>
        <div class="stat-value">{{ metrics.active_cases | default(0) }}</div>
        <div class="stat-label">Active Pipeline</div>
        <div class="stat-change positive">
            {{ metrics.high_value_count | default(0) }} high-value
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon blue">üí∞</div>
        <div class="stat-value">${{ "{:,.0f}".format(metrics.avg_arv | default(0)) }}</div>
        <div class="stat-label">Average ARV</div>
        <div class="stat-change">
            ${{ "{:,.0f}".format(metrics.avg_rehab | default(0)) }} avg rehab
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon orange">üìà</div>
        <div class="stat-value">${{ "{:,.0f}".format(metrics.total_potential_profit | default(0)) }}</div>
        <div class="stat-label">Pipeline Value</div>
        <div class="stat-change positive">
            Total potential profit
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-xl);">
    <div class="stat-card">
        <div class="stat-icon" style="background: var(--warning-light); color: var(--warning);">‚ö†Ô∏è</div>
        <div class="stat-value">{{ metrics.short_sale_count | default(0) }}</div>
        <div class="stat-label">Short Sales</div>
        <div class="stat-change">Liens exceed offer</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(102, 126, 234, 0.1); color: var(--primary);">üè†</div>
        <div class="stat-value">{{ metrics.owner_occupied_count | default(0) }}</div>
        <div class="stat-label">Owner Occupied</div>
        <div class="stat-change positive">{{ metrics.high_equity_count | default(0) }} high equity</div>
    </div>
</div>

<!-- Deal Pipeline Funnel -->
{% if funnel %}
<div class="card" style="margin-bottom: var(--space-xl);">
    <div class="card-header">
        <h3 class="card-title">Deal Pipeline</h3>
    </div>
    <div class="card-body">
        <div style="display: flex; gap: var(--space-md); align-items: center;">
            <div style="flex: 1; text-align: center; padding: var(--space-lg); background: var(--bg-alt); border-radius: var(--radius-md);">
                <div style="font-size: 28px; font-weight: 700; color: var(--text);">{{ funnel.total_leads }}</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Total Leads</div>
            </div>
            <div style="color: var(--text-muted); font-size: 24px;">‚Üí</div>
            <div style="flex: 1; text-align: center; padding: var(--space-lg); background: var(--bg-alt); border-radius: var(--radius-md);">
                <div style="font-size: 28px; font-weight: 700; color: var(--text);">{{ funnel.contacted }}</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Contacted</div>
                <div style="font-size: 12px; color: var(--success); margin-top: 4px;">{{ funnel.contact_rate | default(0) }}%</div>
            </div>
            <div style="color: var(--text-muted); font-size: 24px;">‚Üí</div>
            <div style="flex: 1; text-align: center; padding: var(--space-lg); background: var(--bg-alt); border-radius: var(--radius-md);">
                <div style="font-size: 28px; font-weight: 700; color: var(--text);">{{ funnel.offer_sent }}</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Offers Sent</div>
                <div style="font-size: 12px; color: var(--success); margin-top: 4px;">{{ funnel.offer_rate | default(0) }}%</div>
            </div>
            <div style="color: var(--text-muted); font-size: 24px;">‚Üí</div>
            <div style="flex: 1; text-align: center; padding: var(--space-lg); background: var(--bg-alt); border-radius: var(--radius-md);">
                <div style="font-size: 28px; font-weight: 700; color: var(--text);">{{ funnel.offer_accepted }}</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Accepted</div>
            </div>
            <div style="color: var(--text-muted); font-size: 24px;">‚Üí</div>
            <div style="flex: 1; text-align: center; padding: var(--space-lg); background: var(--success-light); border-radius: var(--radius-md);">
                <div style="font-size: 28px; font-weight: 700; color: var(--success);">{{ funnel.closed_won }}</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Closed Won</div>
                <div style="font-size: 12px; color: var(--success); margin-top: 4px;">{{ funnel.close_rate | default(0) }}%</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- AI Deal Score Distribution -->
<div class="card" style="margin-bottom: var(--space-xl);">
    <div class="card-header">
        <h3 class="card-title">ü§ñ AI Deal Score Distribution</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xl); align-items: center;">
            <div style="height: 220px;">
                <canvas id="scoreDistributionChart"></canvas>
            </div>
            <div>
                <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                    <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-sm) var(--space-md); background: var(--success-light); border-radius: var(--radius-md);">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--success);"></span>
                        <span style="color: var(--text); font-size: 14px; flex: 1;">Excellent (80-100)</span>
                        <span style="font-weight: 700; color: var(--success);" id="count-excellent">0</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-sm) var(--space-md); background: var(--info-light); border-radius: var(--radius-md);">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--info);"></span>
                        <span style="color: var(--text); font-size: 14px; flex: 1;">Good (60-79)</span>
                        <span style="font-weight: 700; color: var(--info);" id="count-good">0</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-sm) var(--space-md); background: var(--warning-light); border-radius: var(--radius-md);">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning);"></span>
                        <span style="color: var(--text); font-size: 14px; flex: 1;">Fair (40-59)</span>
                        <span style="font-weight: 700; color: #b45309;" id="count-fair">0</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-sm) var(--space-md); background: var(--danger-light); border-radius: var(--radius-md);">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--danger);"></span>
                        <span style="color: var(--text); font-size: 14px; flex: 1;">Poor (0-39)</span>
                        <span style="font-weight: 700; color: var(--danger);" id="count-poor">0</span>
                    </div>
                </div>
                <div style="margin-top: var(--space-lg); padding-top: var(--space-md); border-top: 1px solid var(--border);">
                    <span style="color: var(--text-secondary); font-size: 14px;">Total Analyzed: </span>
                    <span style="font-weight: 700; color: var(--text); font-size: 18px;" id="count-total">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Opportunities -->
{% if opportunities %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Top Opportunities</h3>
        <a href="/cases" class="btn btn-secondary btn-sm">View All</a>
    </div>
    <div class="table-container" style="border: none; border-radius: 0;">
        <table class="table">
            <thead>
                <tr>
                    <th>Case #</th>
                    <th>Address</th>
                    <th>ARV</th>
                    <th>Potential Profit</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for opp in opportunities %}
                <tr onclick="window.location.href='/cases/{{ opp.id }}'" style="cursor: pointer;">
                    <td><strong>{{ opp.case_number }}</strong></td>
                    <td>{{ opp.address[:40] }}{% if opp.address|length > 40 %}...{% endif %}</td>
                    <td>${{ "{:,.0f}".format(opp.arv) }}</td>
                    <td><span style="color: var(--success); font-weight: 600;">${{ "{:,.0f}".format(opp.potential_profit) }}</span></td>
                    <td><span class="badge badge-primary">{{ opp.status | title }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/api/v2/analytics/deal-distribution');
        if (!response.ok) return;
        
        const data = await response.json();
        const dist = data.distribution || {};
        
        // Update counts
        document.getElementById('count-excellent').textContent = dist.excellent || 0;
        document.getElementById('count-good').textContent = dist.good || 0;
        document.getElementById('count-fair').textContent = dist.fair || 0;
        document.getElementById('count-poor').textContent = dist.poor || 0;
        document.getElementById('count-total').textContent = data.total_analyzed || 0;
        
        // Create chart
        const ctx = document.getElementById('scoreDistributionChart');
        if (ctx && typeof Chart !== 'undefined') {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Excellent', 'Good', 'Fair', 'Poor'],
                    datasets: [{
                        data: [dist.excellent || 0, dist.good || 0, dist.fair || 0, dist.poor || 0],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: { legend: { display: false } }
                }
            });
        }
    } catch (e) {
        console.error('Error loading deal distribution:', e);
    }
});
</script>
{% endblock %}
