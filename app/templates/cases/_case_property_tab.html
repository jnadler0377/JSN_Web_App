{# app/templates/cases/_case_property_tab.html - V3 Design #}

{# Determine if user can view sensitive data - default to FALSE (restricted) #}
{% if visibility is defined and visibility and visibility.can_view_sensitive %}
    {% set can_view = true %}
{% else %}
    {% set can_view = false %}
{% endif %}

{% if not can_view %}
<!-- Locked Property Data for non-owners -->
<div style="text-align: center; padding: 48px; background: var(--bg-alt); border-radius: var(--radius-lg);">
    <span style="font-size: 48px; display: block; margin-bottom: 16px;">üîí</span>
    <h3 style="margin: 0 0 8px 0;">Property Data Locked</h3>
    <p style="color: var(--text-muted); margin: 0 0 16px 0;">Claim this case to view full property details including owner information and mailing address.</p>
    {% if visibility and visibility.can_claim %}
    <button class="btn btn-primary" onclick="claimCase({{ case.id }})">üîí Claim to Unlock</button>
    {% endif %}
</div>

{% elif property_data %}

<!-- Owner Information -->
<div class="property-section">
    <h3>
        <span>üë§ Owner Information</span>
        <button type="button" class="btn btn-ghost btn-sm" onclick="toggleEditMode('owner-section')">Edit</button>
    </h3>
    <form method="post" action="/cases/{{ case.id }}/property/update-owner" id="owner-section">
        {% if property_data.owners and property_data.owners|length > 0 %}
            {% for owner in property_data.owners %}
            <div class="property-field" style="margin-bottom: 16px;">
                <label>Owner {{ loop.index }}</label>
                <div class="value">{{ owner.fullName or 'N/A' }}</div>
                <input type="text" name="owner_name_{{ loop.index }}" value="{{ owner.fullName or '' }}" class="form-control edit-field" style="display: none;">
            </div>
            {% endfor %}
            
            <h4 style="margin: 24px 0 16px 0; padding-top: 16px; border-top: 1px solid var(--border); font-size: 14px; color: var(--text-secondary);">
                Mailing Address
            </h4>
            
            {% set shared_address = property_data.owners[0].mailingAddress %}
            <div class="property-grid">
                <div class="property-field">
                    <label>Street</label>
                    <div class="value">{{ shared_address.street or 'N/A' }}</div>
                    <input type="text" name="mailing_street" value="{{ shared_address.street or '' }}" class="form-control edit-field" style="display: none;">
                </div>
                <div class="property-field">
                    <label>City</label>
                    <div class="value">{{ shared_address.city or 'N/A' }}</div>
                    <input type="text" name="mailing_city" value="{{ shared_address.city or '' }}" class="form-control edit-field" style="display: none;">
                </div>
                <div class="property-field">
                    <label>State</label>
                    <div class="value">{{ shared_address.state or 'N/A' }}</div>
                    <input type="text" name="mailing_state" value="{{ shared_address.state or '' }}" class="form-control edit-field" style="display: none;">
                </div>
                <div class="property-field">
                    <label>ZIP Code</label>
                    <div class="value">{{ shared_address.zipCode or 'N/A' }}</div>
                    <input type="text" name="mailing_zip" value="{{ shared_address.zipCode or '' }}" class="form-control edit-field" style="display: none;">
                </div>
            </div>
            <input type="hidden" name="owner_count" value="{{ property_data.owners|length }}">
        {% else %}
            <div class="property-field">
                <label>Owner</label>
                <div class="value">N/A</div>
            </div>
        {% endif %}
        <button type="submit" class="btn btn-primary edit-field" style="display: none; margin-top: 16px;">Save Changes</button>
    </form>
</div>

<!-- Property Flags -->
{% if property_data.quickList %}
<div class="property-section">
    <h3>üè∑Ô∏è Property Flags</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        {% for key, value in property_data.quickList.items() %}
            <span class="flag-badge {% if not value %}false{% endif %}">
                {{ key | replace('_', ' ') | title }}: {{ '‚úì' if value else '‚úó' }}
            </span>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Valuation -->
{% if property_data.valuation %}
<div class="property-section">
    <h3>
        <span>üí∞ Valuation</span>
        <button type="button" class="btn btn-ghost btn-sm" onclick="toggleEditMode('valuation-section')">Edit</button>
    </h3>
    <form method="post" action="/cases/{{ case.id }}/property/update-valuation" id="valuation-section">
        <div class="property-grid">
            <div class="property-field">
                <label>Estimated Value</label>
                <div class="value">${{ "{:,.0f}".format(property_data.valuation.estimatedValue) if property_data.valuation.estimatedValue else 'N/A' }}</div>
                <input type="number" name="estimated_value" step="0.01" value="{{ property_data.valuation.estimatedValue or '' }}" class="form-control edit-field" style="display: none;">
            </div>
            <div class="property-field">
                <label>As of Date</label>
                <div class="value">{{ property_data.valuation.asOfDate | format_date if property_data.valuation.asOfDate else 'N/A' }}</div>
                <input type="date" name="as_of_date" value="{{ property_data.valuation.asOfDate or '' }}" class="form-control edit-field" style="display: none;">
            </div>
            <div class="property-field">
                <label>Confidence Score</label>
                <div class="value">{{ property_data.valuation.confidenceScore or 'N/A' }}</div>
                <input type="number" name="confidence_score" step="0.01" value="{{ property_data.valuation.confidenceScore or '' }}" class="form-control edit-field" style="display: none;">
            </div>
            <div class="property-field">
                <label>Equity Percent</label>
                <div class="value">{{ "{:.1f}%".format(property_data.valuation.equityPercent) if property_data.valuation.equityPercent else 'N/A' }}</div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary edit-field" style="display: none; margin-top: 16px;">Save Changes</button>
    </form>
</div>
{% endif %}

<!-- Demographics -->
{% if property_data.demographics %}
<div class="property-section">
    <h3>
        <span>üë• Demographics</span>
        <button type="button" class="btn btn-ghost btn-sm" onclick="toggleEditMode('demographics-section')">Edit</button>
    </h3>
    <form method="post" action="/cases/{{ case.id }}/property/update-demographics" id="demographics-section">
        <div class="property-grid">
            <div class="property-field">
                <label>Age</label>
                <div class="value">{{ property_data.demographics.age or 'N/A' }}</div>
                <input type="number" name="age" value="{{ property_data.demographics.age or '' }}" class="form-control edit-field" style="display: none;">
            </div>
            <div class="property-field">
                <label>Gender</label>
                <div class="value">{{ property_data.demographics.gender or 'N/A' }}</div>
                <select name="gender" class="form-control edit-field" style="display: none;">
                    <option value="">Unknown</option>
                    <option value="Male" {% if property_data.demographics.gender == 'Male' %}selected{% endif %}>Male</option>
                    <option value="Female" {% if property_data.demographics.gender == 'Female' %}selected{% endif %}>Female</option>
                </select>
            </div>
            <div class="property-field">
                <label>Marital Status</label>
                <div class="value">{{ property_data.demographics.maritalStatus or 'N/A' }}</div>
                <input type="text" name="marital_status" value="{{ property_data.demographics.maritalStatus or '' }}" class="form-control edit-field" style="display: none;">
            </div>
            <div class="property-field">
                <label>Income</label>
                <div class="value">${{ "{:,.0f}".format(property_data.demographics.income) if property_data.demographics.income else 'N/A' }}</div>
                <input type="number" name="income" step="1000" value="{{ property_data.demographics.income or '' }}" class="form-control edit-field" style="display: none;">
            </div>
            <div class="property-field">
                <label>Net Worth</label>
                <div class="value">${{ "{:,.0f}".format(property_data.demographics.netWorth) if property_data.demographics.netWorth else 'N/A' }}</div>
                <input type="number" name="net_worth" step="1000" value="{{ property_data.demographics.netWorth or '' }}" class="form-control edit-field" style="display: none;">
            </div>
            <div class="property-field">
                <label>Occupation</label>
                <div class="value">{{ property_data.demographics.individualOccupation or 'N/A' }}</div>
                <input type="text" name="occupation" value="{{ property_data.demographics.individualOccupation or '' }}" class="form-control edit-field" style="display: none;">
            </div>
        </div>
        <button type="submit" class="btn btn-primary edit-field" style="display: none; margin-top: 16px;">Save Changes</button>
    </form>
</div>
{% endif %}

<!-- Property Details -->
{% if property_data.properties %}
<div class="property-section">
    <h3>üè† Property Details</h3>
    <div class="property-grid">
        <div class="property-field">
            <label>Street Address</label>
            <div class="value">{{ property_data.properties.street or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>City</label>
            <div class="value">{{ property_data.properties.city or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>State</label>
            <div class="value">{{ property_data.properties.state or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>ZIP Code</label>
            <div class="value">{{ property_data.properties.zipCode or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>County</label>
            <div class="value">{{ property_data.properties.county or 'N/A' }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Property IDs -->
{% if property_data.ids %}
<div class="property-section">
    <h3>üî¢ Property IDs</h3>
    <div class="property-grid">
        <div class="property-field">
            <label>APN (Assessor's Parcel Number)</label>
            <div class="value">{{ property_data.ids.apn or 'N/A' }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Mortgage History -->
{% if property_data.mortgageHistory and property_data.mortgageHistory | length > 0 %}
<div class="property-section">
    <h3>üè¶ Mortgage History</h3>
    <div style="overflow-x: auto;">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Document Date</th>
                    <th>Lender</th>
                    <th>Loan Amount</th>
                    <th>Interest Rate</th>
                    <th>Loan Type</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody>
                {% for mortgage in property_data.mortgageHistory %}
                <tr>
                    <td>{{ mortgage.documentDate | format_date if mortgage.documentDate else 'N/A' }}</td>
                    <td>{{ mortgage.lenderName or 'N/A' }}</td>
                    <td>${{ "{:,.0f}".format(mortgage.loanAmount) if mortgage.loanAmount else 'N/A' }}</td>
                    <td>{{ "{:.2f}%".format(mortgage.interestRate) if mortgage.interestRate else 'N/A' }}</td>
                    <td>{{ mortgage.loanType or 'N/A' }}</td>
                    <td>{{ mortgage.dueDate | format_date if mortgage.dueDate else 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Deed History -->
{% if property_data.deedHistory and property_data.deedHistory | length > 0 %}
<div class="property-section">
    <h3>üìú Deed History</h3>
    <div style="overflow-x: auto;">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Document Date</th>
                    <th>Document Type</th>
                    <th>Sale Price</th>
                    <th>Buyers</th>
                </tr>
            </thead>
            <tbody>
                {% for deed in property_data.deedHistory %}
                <tr>
                    <td>{{ deed.documentDate | format_date if deed.documentDate else 'N/A' }}</td>
                    <td>{{ deed.documentType or 'N/A' }}</td>
                    <td>${{ "{:,.0f}".format(deed.salePrice) if deed.salePrice else 'N/A' }}</td>
                    <td>{{ deed.buyers or 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Foreclosure Info -->
{% if property_data.foreclosure %}
<div class="property-section">
    <h3>‚öñÔ∏è Foreclosure Information</h3>
    <div class="property-grid">
        <div class="property-field">
            <label>Case Number</label>
            <div class="value">{{ property_data.foreclosure.caseNumber or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>Filing Date</label>
            <div class="value">{{ property_data.foreclosure.filingDate | format_date if property_data.foreclosure.filingDate else 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>Current Lender</label>
            <div class="value">{{ property_data.foreclosure.currentLenderName or 'N/A' }}</div>
        </div>
        <div class="property-field">
            <label>Document Type</label>
            <div class="value">{{ property_data.foreclosure.documentType or 'N/A' }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Raw JSON (Admin Only) -->
{% set is_admin = current_user.is_admin if current_user and current_user.is_admin is defined else (current_user.role == 'admin' if current_user and current_user.role is defined else false) %}
{% if is_admin %}
<details style="margin-top: 24px;">
    <summary style="cursor: pointer; color: var(--text-muted); font-size: 14px; padding: 8px 0;">
        üîç View Raw JSON Data
    </summary>
    <pre style="background: var(--bg-alt); padding: 16px; border-radius: var(--radius-md); overflow-x: auto; margin-top: 8px; font-size: 12px; border: 1px solid var(--border);">{{ property_payload | tojson(indent=2) if property_payload else 'No data' }}</pre>
</details>
{% endif %}

<script>
function toggleEditMode(sectionId) {
    const section = document.getElementById(sectionId);
    if (!section) return;
    
    const isEditing = section.classList.contains('edit-mode');
    const values = section.querySelectorAll('.value');
    const editFields = section.querySelectorAll('.edit-field');
    
    if (isEditing) {
        section.classList.remove('edit-mode');
        values.forEach(v => v.style.display = 'block');
        editFields.forEach(f => f.style.display = 'none');
    } else {
        section.classList.add('edit-mode');
        values.forEach(v => v.style.display = 'none');
        editFields.forEach(f => f.style.display = 'block');
    }
}
</script>

{% else %}

<!-- No Property Data -->
<div class="card">
    <div class="card-body" style="text-align: center; padding: 48px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
        <h3 style="margin-bottom: 8px;">No Property Data Available</h3>
        <p style="color: var(--text-muted); margin-bottom: 24px;">
            Property data has not been fetched yet.
        </p>
        <form method="post" action="/cases/{{ case.id }}/property-lookup" style="display: inline;">
            <button type="submit" class="btn btn-primary btn-lg">üîç Fetch Property Data ($0.80)</button>
        </form>
    </div>
</div>

{% endif %}
